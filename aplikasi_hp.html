<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aplikasi HP – Versi Pro</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jQuery, Select2, jQuery UI (datepicker) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

  <!-- Icons & Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Export libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{ --yellow:#f59e0b }
    html,body{height:100%}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#fff,#fffef0)}
    .section-hidden{display:none}
    .select2-container{width:100%!important}
    .whatsapp-link{color:#25D366}
    .badge{border-radius:999px;padding:2px 8px;font-size:11px;display:inline-flex;align-items:center;gap:6px}
    .badge-stop{background:#fee2e2;color:#b91c1c}
    .badge-go{background:#dcfce7;color:#166534}
    .progress-wrap{height:8px;background:#f1f5f9;border-radius:9999px;overflow:hidden}
    .progress-bar{height:100%;background:var(--yellow);width:0}
    .sortable{cursor:pointer}
    .sortable:after{content:'\25BE';margin-left:6px;opacity:.4}
    .sortable.asc:after{content:'\25B4'}

    .metric-card{
      background:#fff;border-radius:16px;box-shadow:0 8px 28px rgba(15,23,42,.10);
      padding:18px 20px;display:flex;align-items:center;gap:14px;
      transition:transform .15s ease, box-shadow .15s ease;cursor:pointer;
    }
    .metric-card:hover{ transform:translateY(-2px); box-shadow:0 12px 32px rgba(15,23,42,.12); }
    .metric-icon{ width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center; }
    .metric-title{font-size:14px;color:#6b7280}
    .metric-value{font-size:30px;font-weight:700;color:#111827;line-height:1}
    .icon-blue { background:#e0ecff;color:#3973ff }
    .icon-green{ background:#e8f9ef;color:#16a34a }
    .icon-amber{ background:#fff2cc;color:#d97706 }
    .icon-red  { background:#ffe4e6;color:#ef4444 }

    @media (max-width: 768px) {
      .container { padding-left: 1rem; padding-right: 1rem; }
      .tab-btn { font-size: 0.75rem; padding: 0.5rem; }
      .metric-value { font-size: 24px; }
      .metric-title { font-size: 12px; }
      .metric-icon { width: 40px; height: 40px; }
      .metric-card { padding: 14px 16px; }
      table { font-size: 0.75rem; }
      th, td { padding: 0.5rem 0.25rem; }
      .progress-wrap { height: 6px; }
    }

    .ui-datepicker { font-size:0.9rem; width:17em; }
    .ui-datepicker .ui-datepicker-header { padding:0.3em 0; }
    .ui-datepicker .ui-datepicker-title { font-size:0.9rem; }
    .ui-datepicker th { font-size:0.8rem; padding:0.3em; }
    .ui-datepicker td { padding:0; }
    .ui-datepicker td a, .ui-datepicker td span { padding:0.3em; }

    @media (max-width: 768px) {
      #edit-modal .bg-white { margin:1rem;width:calc(100% - 2rem); }
    }
  </style>
</head>
<body class="min-h-full">
  <div class="container mx-auto px-4 py-4 md:py-8 max-w-7xl">
    <!-- Tombol Kembali -->
    <div class="mb-4">
      <a href="index.html"
         class="inline-flex items-center bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition duration-300">
        <i class="fas fa-arrow-left mr-2"></i> Kembali
      </a>
    </div>

    <!-- Header -->
    <header class="mb-6 md:mb-8 text-center">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Aplikasi HP – Versi Pro</h1>
      <p class="text-gray-600 text-sm md:text-base">Sistem Manajemen Data Handphone Karyawan</p>
    </header>

    <!-- Tabs -->
    <div class="flex border-b border-gray-200 mb-4 md:mb-6 overflow-x-auto">
      <button class="tab-btn px-3 py-2 md:px-4 font-medium text-sm border-b-2 border-yellow-500 text-yellow-600 whitespace-nowrap" data-tab="input">
        <i class="fas fa-plus-circle mr-1 md:mr-2"></i>Input Data
      </button>
      <button class="tab-btn px-3 py-2 md:px-4 font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="data">
        <i class="fas fa-table mr-1 md:mr-2"></i>Data HP
      </button>
      <button class="tab-btn px-3 py-2 md:px-4 font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="dashboard">
        <i class="fas fa-chart-bar mr-1 md:mr-2"></i>Dashboard
      </button>
      <button class="tab-btn px-3 py-2 md:px-4 font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="settings">
        <i class="fas fa-cog mr-1 md:mr-2"></i>Pengaturan
      </button>
    </div>

    <!-- ================= INPUT ================= -->
    <section id="input-section" class="tab-content">
      <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
        <h2 class="text-lg md:text-xl font-semibold mb-4 text-gray-800">Input Data HP Baru</h2>

        <!-- PERINGATAN ANGSURAN (INPUT) -->
        <div id="angsuran-warning-input" class="hidden mb-4 rounded-md border border-yellow-300 bg-yellow-50 p-3 text-yellow-800">
          <div class="flex items-start gap-3">
            <i class="fas fa-triangle-exclamation mt-0.5"></i>
            <div>
              <div class="font-semibold">NPK ini masih memiliki angsuran aktif</div>
              <div class="text-sm">
                Sistem mendeteksi ada cicilan yang belum selesai untuk NPK ini. Pastikan data yang diinput benar.
              </div>
              <div id="angsuran-list" class="mt-2 text-xs text-yellow-900"></div>
              <label class="mt-2 inline-flex items-center gap-2 text-sm">
                <input type="checkbox" id="angsuran-ack-input" class="h-4 w-4 rounded border-gray-300">
                <span>Saya paham, lanjutkan</span>
              </label>
            </div>
          </div>
        </div>

        <form id="input-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
            <input type="text" id="tanggal" name="tanggal" class="tanggal-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">NPK</label>
            <input type="text" id="npk" name="npk" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">No. Telp</label>
            <input type="text" id="notelp" name="notelp" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cicilan (bulan)</label>
            <input type="number" id="cicilan" name="cicilan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" min="1" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipe HP</label>
            <select id="tipehp" name="tipehp" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
              <option value="">Pilih Tipe HP</option>
              <option value="VIVO Y29 6/128">VIVO Y29 6/128</option>
              <option value="VIVO Y29 8/128">VIVO Y29 8/128</option>
              <option value="VIVO Y29 8/256">VIVO Y29 8/256</option>
              <option value="Y19S PRO 4/64 GB">Y19S PRO 4/64 GB</option>
              <option value="Y19S PRO 4/128 GB">Y19S PRO 4/128 GB</option>
              <option value="Y19S PRO 6/128 GB">Y19S PRO 6/128 GB</option>
              <option value="REDMI 14C 6/128">REDMI 14C 6/128</option>
              <option value="REDMI 14C 8/256">REDMI 14C 8/256</option>
              <option value="REDMI NOTE 14 8/128">REDMI NOTE 14 8/128</option>
              <option value="REDMI NOTE 14 8/256">REDMI NOTE 14 8/256</option>
              <option value="REDMI NOTE 14 8/256 5G">REDMI NOTE 14 8/256 5G</option>
              <option value="REDMI NOTE 14 12/512 5G">REDMI NOTE 14 12/512 5G</option>
              <option value="REDMI 13 8/128">REDMI 13 8/128</option>
              <option value="REDMI 13 8/256">REDMI 13 8/256</option>
              <option value="REDMI POCO PAD 8/256">REDMI POCO PAD 8/256</option>
              <option value="OPPO A60 8/256">OPPO A60 8/256</option>
              <option value="OPPO A3X 6/128">OPPO A3X 6/128</option>
              <option value="REALME C75 8/128">REALME C75 8/128</option>
              <option value="REALME C75 8/256">REALME C75 8/256</option>
              <option value="REALME NOTE 60 6/128">REALME NOTE 60 6/128</option>
              <option value="SAMSUNG A06 4/64">SAMSUNG A06 4/64</option>
              <option value="SAMSUNG A06 4/128">SAMSUNG A06 4/128</option>
              <option value="SAMSUNG A06 6/128">SAMSUNG A06 6/128</option>
              <option value="SAMSUNG A16 8/128">SAMSUNG A16 8/128</option>
              <option value="SAMSUNG A16 8/256">SAMSUNG A16 8/256</option>
              <option value="SAMSUNG A16 8/256 5G">SAMSUNG A16 8/256 5G</option>
              <option value="SMART 10 4/128 GB">SMART 10 4/128 GB</option>
              <option value="SMART 10 PLUS 8/128 GB">SMART 10 PLUS 8/128 GB</option>
              <option value="HOT 60i 8/256 GB">HOT 60i 8/256 GB</option>
              <option value="HOT 60 PRO 8/256 GB">HOT 60 PRO 8/256 GB</option>
              <option value="INFINIX HOT 50 PRO+ 8/256">INFINIX HOT 50 PRO+ 8/256</option>
              <option value="TECNO SPARK GO 1 4/128">TECNO SPARK GO 1 4/128</option>
              <option value="POVA 7 8/128 GB">POVA 7 8/128 GB</option>
              <option value="POVA 7 8/256 GB">POVA 7 8/256 GB</option>
              <option value="CAMON 40 8/256 GB">CAMON 40 8/256 GB</option>
              <option value="ADVAN TAB VX LITE 6/128GB">ADVAN TAB VX LITE 6/128GB</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Kirim</label>
            <input type="text" id="alamat" name="alamat" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="status" name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <option value="">Pilih Status</option>
              <option value="OK">OK</option>
              <option value="CANCEL">CANCEL</option>
              <option value="NO ACC">NO ACC</option>
              <option value="VERIFIKASI">VERIFIKASI</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
            <input type="text" id="keterangan" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
          </div>
          <div class="md:col-span-2">
            <button id="btn-submit" type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-md transition duration-300">
              <i class="fas fa-save mr-2"></i>Simpan Data
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- ================= DATA ================= -->
    <section id="data-section" class="tab-content section-hidden">
      <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
          <h2 class="text-lg md:text-xl font-semibold text-gray-800 mb-2 md:mb-0">Data HP Karyawan</h2>
          <div class="flex flex-wrap gap-2">
            <button id="refresh-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-sync-alt mr-1"></i> Refresh
            </button>
            <button id="export-excel-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-file-excel mr-1"></i> Excel
            </button>
            <button id="export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-file-pdf mr-1"></i> PDF
            </button>
            <div class="relative">
              <input type="text" id="search-input" placeholder="Cari data..." class="pl-8 pr-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <i class="fas fa-search absolute left-2 top-2 text-gray-400"></i>
            </div>
          </div>
        </div>

        <!-- Filter -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Urutkan Tanggal</label>
            <select id="sort-tanggal" class="w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <option value="asc">Terlama ke Terbaru</option>
              <option value="desc">Terbaru ke Terlama</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Filter Status</label>
            <select id="filter-status" class="w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <option value="">Semua Status</option>
              <option value="OK">OK</option>
              <option value="CANCEL">CANCEL</option>
              <option value="NO ACC">NO ACC</option>
              <option value="VERIFIKASI">VERIFIKASI</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Awal</label>
            <input type="text" id="filter-tanggal-awal" class="tanggal-input w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
            <input type="text" id="filter-tanggal-akhir" class="tanggal-input w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
          </div>
        </div>

        <div class="overflow-x-auto">
          <table id="data-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NPK</th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Telp</th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe HP</th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cicilan</th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Masa Cicilan</th>
                <th class="px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>

        <div class="mt-4 flex flex-col md:flex-row justify-between items-center gap-2">
          <div class="text-sm text-gray-700">
            Menampilkan <span id="showing-count">0</span> dari <span id="total-count">0</span> data
          </div>
          <div class="flex space-x-1">
            <button id="prev-page" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-md text-sm disabled:opacity-50" disabled>
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="page-info" class="px-3 py-1 text-sm">Halaman 1 dari 1</span>
            <button id="next-page" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-md text-sm disabled:opacity-50" disabled>
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- ================= DASHBOARD ================= -->
    <section id="dashboard-section" class="tab-content section-hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6">
        <div id="card-total" class="metric-card" role="button" tabindex="0" data-qfilter="ALL" aria-label="Total HP">
          <div class="metric-icon icon-blue"><i class="fas fa-mobile-screen-button"></i></div>
          <div>
            <div class="metric-title">Total HP</div>
            <div id="total-hp" class="metric-value">0</div>
          </div>
        </div>
        <div id="card-ok" class="metric-card" role="button" tabindex="0" data-qfilter="OK" aria-label="Status OK">
          <div class="metric-icon icon-green"><i class="fas fa-check"></i></div>
          <div><div class="metric-title">Status OK</div><div id="status-ok" class="metric-value">0</div></div>
        </div>
        <div id="card-proses" class="metric-card" role="button" tabindex="0" data-qfilter="PROSES" aria-label="Dalam Proses">
          <div class="metric-icon icon-amber"><i class="fas fa-hourglass-half"></i></div>
          <div><div class="metric-title">Dalam Proses</div><div id="status-proses" class="metric-value">0</div></div>
        </div>
        <div id="card-issues" class="metric-card" role="button" tabindex="0" data-qfilter="ISSUES" aria-label="Bermasalah">
          <div class="metric-icon icon-red"><i class="fas fa-xmark"></i></div>
          <div><div class="metric-title">Bermasalah</div><div id="status-issues" class="metric-value">0</div></div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
          <h3 class="text-lg font-semibold mb-4 text-gray-800">Distribusi Tipe HP</h3>
          <div class="h-64"><canvas id="tipe-hp-chart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
          <h3 class="text-lg font-semibold mb-4 text-gray-800">Status HP</h3>
          <div class="h-64"><canvas id="status-chart"></canvas></div>
        </div>
      </div>
    </section>

    <!-- ================= SETTINGS ================= -->
    <section id="settings-section" class="tab-content section-hidden">
      <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
        <h2 class="text-lg md:text-xl font-semibold mb-4 text-gray-800">Pengaturan Aplikasi</h2>
        <div class="mb-6">
          <h3 class="text-md font-medium mb-2 text-gray-700">Refresh Data</h3>
          <p class="text-sm text-gray-600 mb-3">Refresh semua data perhitungan masa cicilan</p>
          <button id="refresh-all-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition duration-300">
            <i class="fas fa-sync-alt mr-2"></i>Refresh Semua Data
          </button>
        </div>
        <div class="mb-6">
          <h3 class="text-md font-medium mb-2 text-gray-700">Tentang Aplikasi</h3>
          <div class="bg-gray-50 p-4 rounded-md">
            <p class="text-sm text-gray-700 mb-2"><strong>Nama Aplikasi:</strong> Aplikasi HP – Versi Pro</p>
            <p class="text-sm text-gray-700 mb-2"><strong>Versi:</strong> 2025.08.19</p>
            <p class="text-sm text-gray-700"><strong>Deskripsi:</strong> Sistem manajemen data handphone karyawan dengan fitur pencatatan, monitoring, dan pelaporan.</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal Edit (tetap ada, tidak diubah pada permintaan ini) -->
  <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-screen overflow-y-auto">
      <div class="p-4 md:p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg md:text-xl font-semibold text-gray-800">Edit Data HP</h3>
          <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
        </div>

        <form id="edit-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="edit-id" name="id">
          <input type="hidden" id="edit-row" name="row">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
            <input type="text" id="edit-tanggal" name="tanggal" class="tanggal-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">NPK</label>
            <input type="text" id="edit-npk" name="npk" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">No. Telp</label>
            <input type="text" id="edit-notelp" name="notelp" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cicilan (bulan)</label>
            <input type="number" id="edit-cicilan" name="cicilan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" min="1" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipe HP</label>
            <select id="edit-tipehp" name="tipehp" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Kirim</label>
            <input type="text" id="edit-alamat" name="alamat" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="edit-status" name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <option value="">Pilih Status</option>
              <option value="OK">OK</option>
              <option value="CANCEL">CANCEL</option>
              <option value="NO ACC">NO ACC</option>
              <option value="VERIFIKASI">VERIFIKASI</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
            <input type="text" id="edit-keterangan" name="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Stop Mulai</label>
            <input type="text" id="edit-stop-mulai" name="stop_mulai" class="tanggal-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Lanjut Mulai</label>
            <input type="text" id="edit-lanjut-mulai" name="lanjut_mulai" class="tanggal-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
          </div>
          <div class="md:col-span-2">
            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-md transition duration-300">
              <i class="fas fa-save mr-2"></i>Update Data
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Notification Toast -->
  <div id="notification" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 max-w-md transform transition-transform duration-300 translate-y-20 opacity-0 flex items-start">
    <div id="notification-icon" class="mr-3 mt-1"></div>
    <div>
      <h4 id="notification-title" class="font-medium text-gray-800"></h4>
      <p id="notification-message" class="text-sm text-gray-600 mt-1"></p>
    </div>
    <button id="close-notification" class="ml-4 text-gray-400 hover:text-gray-600">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- ================= SCRIPTS ================= -->
  <script>
    // ====== KONFIGURASI ======
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzJTpEVdK54m0NwY-AYqWq0JGCsiIX2mBnvRzbjzN5fgah5rYlczFXTCadS0WDxE6Ld/exec';

    // ====== ENFORCE ADMIN-ONLY ======
    (function enforceAdmin(){
      const qsUser = new URLSearchParams(location.search).get('user') || '';
      const ssUser = sessionStorage.getItem('username') || '';
      const USERNAME = (ssUser || qsUser || '').trim();
      const IS_ADMIN = USERNAME.toLowerCase() === 'adminksn';
      if (!IS_ADMIN) {
        alert('Akses ditolak! Hanya adminksn yang bisa membuka halaman ini.');
        window.location.href = 'index.html';
      }
    })();

    // ====== STATE GLOBAL ======
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let sortColumn = 'tanggal';
    let sortDirection = 'asc';
    let tipeHpChart = null, statusChart = null;
    let quickFilter = 'ALL';

    $(document).ready(function() {
      $(".tanggal-input").datepicker({ dateFormat: "dd/mm/yy", changeMonth: true, changeYear: true, yearRange: "2020:2035" });

      // Tab nav
      $('.tab-btn').click(function() {
        const tabId = $(this).data('tab');
        $('.tab-btn').removeClass('border-b-2 border-yellow-500 text-yellow-600').addClass('text-gray-500 hover:text-gray-700');
        $(this).removeClass('text-gray-500 hover:text-gray-700').addClass('border-b-2 border-yellow-500 text-yellow-600');
        $('.tab-content').addClass('section-hidden');
        $(`#${tabId}-section`).removeClass('section-hidden');
        if (tabId === 'data') { renderTable(); }
        if (tabId === 'dashboard') { loadDashboard(); }
      });

      // Submit
      $('#input-form').submit(function(e){ e.preventDefault(); submitForm(); });
      $('#edit-form').submit(function(e){ e.preventDefault(); updateData(); });

      // Tombol
      $('#refresh-btn').click(loadData);
      $('#export-excel-btn').click(exportToExcel);
      $('#export-pdf-btn').click(exportToPDF);
      $('#refresh-all-btn').click(refreshAllData);
      document.getElementById('close-notification').addEventListener('click', ()=>document.getElementById('notification').classList.add('translate-y-20','opacity-0'));
      $('#close-modal-btn').click(()=>$('#edit-modal').addClass('hidden'));

      // Filter & Paging
      $('#search-input').on('input', filterData);
      $('#sort-tanggal').change(function(){ sortDirection = $(this).val(); sortData(); renderTable(); });
      $('#filter-status').change(function(){ quickFilter='ALL'; filterData(); });
      $('#filter-tanggal-awal, #filter-tanggal-akhir').on('change', filterData);
      $('#prev-page').click(function(){ if(currentPage>1){ currentPage--; renderTable(); } });
      $('#next-page').click(function(){ const totalPages = Math.ceil(filteredData.length/itemsPerPage); if(currentPage<totalPages){ currentPage++; renderTable(); } });

      // Cek angsuran aktif saat NPK berubah
      $('#npk').on('input blur', function(){
        const npk = ($(this).val() || '').trim();
        checkAngsuranOnInput(npk);
      });

      // Checkbox ack mengunci/lepaskan tombol submit
      $('#angsuran-ack-input').on('change', function(){
        const checked = $(this).is(':checked');
        toggleSubmitDisabled(!checked && !$('#angsuran-warning-input').hasClass('hidden'));
      });

      // Default sort
      $('#sort-tanggal').val('asc');

      // Load awal
      loadData();
    });

    // ====== API LOAD ======
    function loadData() {
      showNotification('info','Memuat Data','Sedang mengambil data dari server...');
      $.ajax({
        url: ENDPOINT, type: 'GET', data: { action:'getAll' }, dataType:'json',
        success: function(res){
          if(res.status==='success'){
            allData = res.data || [];
            filterData();
            showNotification('success','Berhasil','Data berhasil dimuat');
            // Recek NPK bila user sudah mengetik saat data baru datang
            const npk = ($('#npk').val() || '').trim();
            if (npk) checkAngsuranOnInput(npk);
          } else {
            showNotification('error','Gagal', res.message || 'Terjadi kesalahan saat memuat data');
          }
        },
        error: function(){ showNotification('error','Kesalahan','Tidak dapat terhubung ke server'); }
      });
    }

    // ====== SUBMIT & UPDATE ======
    function submitForm(){
      // Guard: kalau peringatan aktif & belum ack → blok
      if (!$('#angsuran-warning-input').hasClass('hidden') && !$('#angsuran-ack-input').is(':checked')) {
        showNotification('warning','Tindakan Diblokir','Centang "Saya paham, lanjutkan" sebelum menyimpan.');
        return;
      }

      const formData = {
        tanggal: $('#tanggal').val(), npk: $('#npk').val(), notelp: $('#notelp').val(),
        cicilan: $('#cicilan').val(), tipehp: $('#tipehp').val(), alamat: $('#alamat').val(),
        keterangan: $('#keterangan').val(), status: $('#status').val()
      };
      showNotification('info','Menyimpan','Sedang menyimpan data...');
      $.ajax({
        url: ENDPOINT, type:'POST', data: formData, dataType:'json',
        success: function(res){
          if(res.status==='success'){
            $('#input-form')[0].reset();
            hideAngsuranWarning();
            loadData();
            showNotification('success','Berhasil','Data berhasil disimpan');
          } else {
            showNotification('error','Gagal', res.message || 'Terjadi kesalahan saat menyimpan data');
          }
        },
        error: function(){ showNotification('error','Kesalahan','Tidak dapat terhubung ke server'); }
      });
    }

    function updateData(){
      const formData = {
        action:'updateData',
        id: $('#edit-id').val(), row: $('#edit-row').val(),
        tanggal: $('#edit-tanggal').val(), npk: $('#edit-npk').val(),
        notelp: $('#edit-notelp').val(), cicilan: $('#edit-cicilan').val(),
        tipehp: $('#edit-tipehp').val(), alamat: $('#edit-alamat').val(),
        keterangan: $('#edit-keterangan').val(), status: $('#edit-status').val(),
        stop_mulai: $('#edit-stop-mulai').val(), lanjut_mulai: $('#edit-lanjut-mulai').val()
      };
      showNotification('info','Memperbarui','Sedang memperbarui data...');
      $.ajax({
        url: ENDPOINT, type:'POST', data: formData, dataType:'json',
        success: function(res){
          if(res.status==='success'){ $('#edit-modal').addClass('hidden'); loadData(); showNotification('success','Berhasil','Data berhasil diperbarui'); }
          else { showNotification('error','Gagal', res.message || 'Terjadi kesalahan saat memperbarui data'); }
        },
        error: function(){ showNotification('error','Kesalahan','Tidak dapat terhubung ke server'); }
      });
    }

    function refreshAllData(){
      showNotification('info','Refresh','Sedang merefresh semua data...');
      $.ajax({
        url: ENDPOINT, type:'POST', data:{ action:'refreshAll' }, dataType:'json',
        success: function(res){
          if(res.status==='success'){ loadData(); showNotification('success','Berhasil', res.message || 'Data berhasil direfresh'); }
          else { showNotification('error','Gagal', res.message || 'Terjadi kesalahan saat refresh data'); }
        },
        error: function(){ showNotification('error','Kesalahan','Tidak dapat terhubung ke server'); }
      });
    }

    // ====== FILTERING & SORTING (Data tab) ======
    function applyQuickFilter(type){
      quickFilter = type;
      $('#search-input').val('');
      $('#filter-status').val('');
      $('#filter-tanggal-awal').val('');
      $('#filter-tanggal-akhir').val('');
      filterData();
      $('.tab-btn[data-tab="data"]').click();
    }

    function filterData(){
      const searchTerm = ($('#search-input').val() || '').toLowerCase();
      const statusSel = $('#filter-status').val();
      const tglAwal = $('#filter-tanggal-awal').val();
      const tglAkhir = $('#filter-tanggal-akhir').val();

      filteredData = [...allData];

      if (tglAwal) {
        const awal = parseDate(tglAwal);
        if (awal) filteredData = filteredData.filter(item => { const t = parseDate(item.tanggal); return t && t >= awal; });
      }
      if (tglAkhir) {
        const akhir = parseDate(tglAkhir);
        if (akhir) {
          akhir.setHours(23, 59, 59, 999);
          filteredData = filteredData.filter(item => { const t = parseDate(item.tanggal); return t && t <= akhir; });
        }
      }

      if (!statusSel) {
        if (quickFilter === 'OK') filteredData = filteredData.filter(x => (x.status || '') === 'OK');
        else if (quickFilter === 'PROSES') filteredData = filteredData.filter(x => (x.status || '') === 'VERIFIKASI');
        else if (quickFilter === 'ISSUES') filteredData = filteredData.filter(x => ['CANCEL','NO ACC'].includes(x.status || ''));
      }
      if (statusSel) filteredData = filteredData.filter(x => (x.status || '') === statusSel);

      if (searchTerm){
        filteredData = filteredData.filter(item => (
          (item.npk || '').toLowerCase().includes(searchTerm) ||
          (item.nama || '').toLowerCase().includes(searchTerm) ||
          (item.notelp || '').toLowerCase().includes(searchTerm) ||
          (item.tipehp || '').toLowerCase().includes(searchTerm) ||
          (item.status || '').toLowerCase().includes(searchTerm) ||
          (item.keterangan || '').toLowerCase().includes(searchTerm)
        ));
      }

      currentPage = 1;
      sortData();
      renderTable();
      updateDashboardCounters();
    }

    function sortData(){
      filteredData.sort((a,b)=>{
        let A = a[sortColumn] || '', B = b[sortColumn] || '';
        if (sortColumn==='tanggal'){ A = parseDate(A); B = parseDate(B); }
        if (sortColumn==='cicilan'){ A = parseInt(A)||0; B = parseInt(B)||0; }
        if (A<B) return sortDirection==='asc' ? -1 : 1;
        if (A>B) return sortDirection==='asc' ? 1 : -1;
        return 0;
      });
    }

    function renderTable(){
      const start = (currentPage-1)*itemsPerPage;
      const pageData = filteredData.slice(start, start+itemsPerPage);
      const tbody = $('#data-table tbody');
      tbody.empty();

      if(pageData.length===0){
        tbody.append('<tr><td colspan="10" class="px-4 py-4 text-center text-gray-500">Tidak ada data yang tersedia</td></tr>');
      } else {
        pageData.forEach(item=>{
          const waLink = item.notelp_link
            ? `<a href="${item.notelp_link}" target="_blank" rel="noopener noreferrer" class="whatsapp-link hover:underline">${item.notelp||''}</a>`
            : (item.notelp||'');

          let statusBadge = '';
          if (item.status==='OK') statusBadge = '<span class="badge badge-go"><i class="fas fa-check-circle"></i> OK</span>';
          else if (['CANCEL','NO ACC'].includes(item.status)) statusBadge = `<span class="badge badge-stop"><i class="fas fa-times-circle"></i> ${item.status}</span>`;
          else if (item.status==='VERIFIKASI') statusBadge = '<span class="badge" style="background:#fef3c7;color:#92400e"><i class="fas fa-exclamation-circle"></i> VERIFIKASI</span>';
          else statusBadge = '<span class="badge" style="background:#f3f4f6;color:#4b5563"><i class="fas fa-question-circle"></i> -</span>';

          const masa = (()=>{
            if (!item.masaCicilan) return '<div class="text-sm text-gray-500">-</div>';
            const p = parseMasaCicilan(item.masaCicilan);
            const cur = p.cur ?? 0, tot = p.tot ?? 0;
            const perc = tot>0 ? Math.min(100, Math.round((cur/tot)*100)) : 0;
            const warnIcon = (p.cur!==null && p.tot!==null && cur < tot)
              ? '<i class="fas fa-triangle-exclamation ml-2 text-yellow-500" title="Masih ada angsuran"></i>'
              : '';
            return `<div class="text-sm flex items-center">${item.masaCicilan}${warnIcon}</div>
                    <div class="progress-wrap mt-1"><div class="progress-bar" style="width:${perc}%"></div></div>`;
          })();

          const tr = `<tr>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.id || item.row || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.tanggal || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.npk || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.nama || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${waLink}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.tipehp || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.cicilan || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm">${statusBadge}</td>
            <td class="px-2 md:px-4 py-3">${masa}</td>
            <td class="px-2 md:px-4 py-3 text-sm">
              <button class="text-blue-500 hover:text-blue-700 mr-3 edit-btn" data-id="${item.id}" data-row="${item.row}">
                <i class="fas fa-edit"></i>
              </button>
            </td>
          </tr>`;
          tbody.append(tr);
        });

        $('.edit-btn').click(function(){ editData($(this).data('id'), $(this).data('row')); });
      }

      $('#showing-count').text(pageData.length);
      $('#total-count').text(filteredData.length);
      const totalPages = Math.ceil(filteredData.length/itemsPerPage) || 1;
      $('#page-info').text(`Halaman ${currentPage} dari ${totalPages}`);
      $('#prev-page').prop('disabled', currentPage===1);
      $('#next-page').prop('disabled', currentPage===totalPages || totalPages===0);
    }

    function editData(id,row){
      const item = allData.find(d => (d.id && d.id==id) || (d.row && d.row==row));
      if (!item) return;
      $('#edit-id').val(item.id || '');
      $('#edit-row').val(item.row || '');
      $('#edit-tanggal').val(item.tanggal || '');
      $('#edit-npk').val(item.npk || '');
      $('#edit-notelp').val(item.notelp || '');
      $('#edit-cicilan').val(item.cicilan || '');
      $('#edit-tipehp').val(item.tipehp || '');
      $('#edit-alamat').val(item.alamat || '');
      $('#edit-keterangan').val(item.keterangan || '');
      $('#edit-status').val(item.status || '');
      $('#edit-stop-mulai').val(item.stopMulai || '');
      $('#edit-lanjut-mulai').val(item.lanjutMulai || '');
      $('#edit-modal').removeClass('hidden');
    }

    // ====== DASHBOARD ======
    function updateDashboardCounters(){
      const total = allData.length;
      const ok = allData.filter(x => x.status==='OK').length;
      const proses = allData.filter(x => x.status==='VERIFIKASI').length;
      const issues = allData.filter(x => ['CANCEL','NO ACC'].includes(x.status||'')).length;
      $('#total-hp').text(total);
      $('#status-ok').text(ok);
      $('#status-proses').text(proses);
      $('#status-issues').text(issues);
    }

    function loadDashboard(){
      updateDashboardCounters();

      const tipeHpCounts = {};
      const statusCounts = { 'OK':0, 'CANCEL':0, 'NO ACC':0, 'VERIFIKASI':0, 'Lainnya':0 };
      allData.forEach(item=>{
        if (item.tipehp){ tipeHpCounts[item.tipehp] = (tipeHpCounts[item.tipehp]||0)+1; }
        if (['OK','CANCEL','NO ACC','VERIFIKASI'].includes(item.status)){
          statusCounts[item.status] = (statusCounts[item.status]||0)+1;
        } else {
          statusCounts['Lainnya'] = (statusCounts['Lainnya']||0)+1;
        }
      });

      const tipeHpCtx = document.getElementById('tipe-hp-chart').getContext('2d');
      if (tipeHpChart) tipeHpChart.destroy();
      tipeHpChart = new Chart(tipeHpCtx, {
        type:'bar',
        data:{ labels:Object.keys(tipeHpCounts),
               datasets:[{ label:'Jumlah HP', data:Object.values(tipeHpCounts),
               backgroundColor:'rgba(245, 158, 11, 0.7)', borderColor:'rgba(245, 158, 11, 1)', borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });

      const statusCtx = document.getElementById('status-chart').getContext('2d');
      if (statusChart) statusChart.destroy();
      const colors = ['rgba(34,197,94,.7)','rgba(239,68,68,.7)','rgba(239,68,68,.7)','rgba(245,158,11,.7)','rgba(156,163,175,.7)'];
      statusChart = new Chart(statusCtx, {
        type:'doughnut',
        data:{ labels:Object.keys(statusCounts), datasets:[{ data:Object.values(statusCounts), backgroundColor:colors, borderColor:colors.map(c=>c.replace('.7', '')), borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right' } } }
      });
    }

    // ====== EXPORT ======
    // DETEKSI Android WebView
    function isAndroidWebView(){
      const ua = navigator.userAgent || '';
      return /Android/i.test(ua) && /wv|Version\/\d+\.\d+ Chrome\/\d+.*Mobile Safari\/\d+/i.test(ua);
    }

    // Fallback download yang aman untuk WebView (hindari blob:)
    async function downloadBlob(blob, fileName){
      // 1) Browser normal + FileSaver
      try {
        if (typeof saveAs === 'function' && !isAndroidWebView()){
          saveAs(blob, fileName);
          return;
        }
      } catch(e) { /* lanjut ke fallback */ }

      // 2) Fallback utama (Android WebView): ubah ke Data URL (base64)
      try {
        const dataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });

        // Gunakan anchor dengan download bila didukung
        const a = document.createElement('a');
        if ('download' in a){
          a.href = dataUrl;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          a.remove();
          return;
        }

        // 3) Last resort: navigasi ke data URL (user bisa Save As)
        window.location.href = dataUrl;
        return;
      } catch(err) {
        // 4) Paling akhir: objectURL (mungkin memicu blob:, tapi kita coba)
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
      }
    }

    async function exportToExcel(){
      if (!filteredData.length){ showNotification('warning','Peringatan','Tidak ada data untuk diekspor'); return; }

      showNotification('info','Ekspor','Menyiapkan file Excel...');
      const tglAwal = $('#filter-tanggal-awal').val() || 'Awal';
      const tglAkhir = $('#filter-tanggal-akhir').val() || 'Akhir';
      const statusFilter = $('#filter-status').val() || 'Semua';
      const d = new Date();
      const dateStr = `${String(d.getDate()).padStart(2,'0')}${String(d.getMonth()+1).padStart(2,'0')}${d.getFullYear()}`;
      const fileName = `Data_HP_${tglAwal.replace(/\//g,'')}_${tglAkhir.replace(/\//g,'')}_${statusFilter}_${dateStr}.xlsx`;

      const exportData = filteredData.map(item=>({
        'ID': item.id || item.row || '',
        'Tanggal': item.tanggal || '',
        'NPK': item.npk || '',
        'Nama': item.nama || '',
        'No. Telp': item.notelp || '',
        'Instalasi': item.instalasi || '',
        'Cicilan': item.cicilan || '',
        'Tipe HP': item.tipehp || '',
        'Alamat Kirim': item.alamat || '',
        'Keterangan': item.keterangan || '',
        'Status': item.status || '',
        'Masa Cicilan': item.masaCicilan || '',
        'Stop Mulai': item.stopMulai || '',
        'Lanjut Mulai': item.lanjutMulai || ''
      }));

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(exportData);
      XLSX.utils.book_append_sheet(wb, ws, 'Data HP');

      const ab = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      const blob = new Blob([ab], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      await downloadBlob(blob, fileName);
      showNotification('success','Berhasil','Excel berhasil dibuat.');
    }

    async function exportToPDF(){
      if (!filteredData.length){ showNotification('warning','Peringatan','Tidak ada data untuk diekspor'); return; }

      showNotification('info','Ekspor','Menyiapkan file PDF...');
      const tglAwal = $('#filter-tanggal-awal').val() || 'Awal';
      const tglAkhir = $('#filter-tanggal-akhir').val() || 'Akhir';
      const statusFilter = $('#filter-status').val() || 'Semua';

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text('Data HP Karyawan', 105, 15, { align:'center' });
      doc.setFontSize(10);
      const d = new Date();
      const ds = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
      doc.text(`Tanggal: ${ds}`, 105, 25, { align:'center' });
      doc.text(`Periode: ${tglAwal} - ${tglAkhir}`, 105, 30, { align:'center' });
      doc.text(`Status: ${statusFilter}`, 105, 35, { align:'center' });

      const tableData = filteredData.map(item=>[
        item.id||item.row||'', item.tanggal||'', item.npk||'', item.nama||'', item.notelp||'',
        item.cicilan||'', item.tipehp||'', item.status||'', item.masaCicilan||'-'
      ]);

      doc.autoTable({
        head:[['ID','Tanggal','NPK','Nama','No. Telp','Cicilan','Tipe HP','Status','Masa Cicilan']],
        body: tableData,
        startY:40,
        styles:{ fontSize:8, cellPadding:3 },
        headStyles:{ fillColor:[245,158,11], textColor:255 }
      });

      const safeName = `Data_HP_${tglAwal.replace(/\//g,'')}_${tglAkhir.replace(/\//g,'')}_${statusFilter}_${ds.replaceAll('/','')}.pdf`;
      const blob = doc.output('blob');
      await downloadBlob(blob, safeName);
      showNotification('success','Berhasil','PDF berhasil dibuat.');
    }

    // ====== UTIL ======
    function showNotification(type,title,message){
      const n = $('#notification'), icon = $('#notification-icon'), t=$('#notification-title'), m=$('#notification-message');
      icon.empty();
      if(type==='success') icon.append('<i class="fas fa-check-circle text-green-500 text-xl"></i>');
      else if(type==='error') icon.append('<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>');
      else if(type==='warning') icon.append('<i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>');
      else icon.append('<i class="fas fa-info-circle text-blue-500 text-xl"></i>');
      t.text(title); m.text(message);
      n.removeClass('translate-y-20 opacity-0');
      setTimeout(()=>n.addClass('translate-y-20 opacity-0'), 5000);
    }

    function parseDate(dateStr){
      if(!dateStr) return null;
      const p = String(dateStr).split('/');
      if(p.length!==3) return null;
      return new Date(parseInt(p[2],10), parseInt(p[1],10)-1, parseInt(p[0],10));
    }

    function parseMasaCicilan(masaStr){
      if (!masaStr) return {cur:null, tot:null};
      const m = String(masaStr).trim().match(/^(\d+)\s*\/\s*(\d+)$/);
      if (!m) return {cur:null, tot:null};
      const cur = parseInt(m[1], 10);
      const tot = parseInt(m[2], 10);
      if (isNaN(cur) || isNaN(tot)) return {cur:null, tot:null};
      return {cur, tot};
    }

    function checkAngsuranOnInput(npk){
      const warn = $('#angsuran-warning-input');
      const list = $('#angsuran-list');
      const ack = $('#angsuran-ack-input');

      if (!npk) { hideAngsuranWarning(); return; }

      // Cari entri NPK dengan masaCicilan cur<tot dan status bukan CANCEL/NO ACC
      const aktif = (allData || []).filter(d => {
        if (!d || (String(d.npk||'').trim() !== npk)) return false;
        const {cur, tot} = parseMasaCicilan(d.masaCicilan || '');
        if (cur===null || tot===null) return false;
        const status = (d.status || '').toUpperCase();
        const statusOk = !['CANCEL','NO ACC'].includes(status);
        return statusOk && cur < tot;
      });

      if (aktif.length > 0){
        // Tampilkan list ringkas
        const rows = aktif.slice(0,5).map(a=>{
          const masa = a.masaCicilan || '-';
          const tgl = a.tanggal || '-';
          const tipe = a.tipehp || '-';
          return `<div>• ${masa} – ${tipe} (Tgl: ${tgl})</div>`;
        }).join('');
        list.html(rows + (aktif.length>5 ? `<div class="italic">+ ${aktif.length-5} data lagi...</div>` : ''));
        warn.removeClass('hidden');
        ack.prop('checked', false);
        toggleSubmitDisabled(true); // kunci submit
      } else {
        hideAngsuranWarning();
      }
    }

    function hideAngsuranWarning(){
      $('#angsuran-warning-input').addClass('hidden');
      $('#angsuran-ack-input').prop('checked', false);
      toggleSubmitDisabled(false);
    }

    function toggleSubmitDisabled(disabled){
      const btn = $('#btn-submit');
      btn.prop('disabled', disabled);
      btn.toggleClass('opacity-50 cursor-not-allowed', disabled);
    }
  </script>
</body>
</html>
