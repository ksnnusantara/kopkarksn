<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aplikasi HP – Versi Pro (Scroll Tanpa Halaman)</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* Styling kustom untuk tampilan yang lebih baik */
    :root{ --yellow:#f59e0b }
    html,body{height:100%}
    body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#fff,#fffef0)}
    .section-hidden{display:none}
    .select2-container{width:100%!important}
    .whatsapp-link{color:#25D366}
    .badge{border-radius:999px;padding:2px 8px;font-size:11px;display:inline-flex;align-items:center;gap:6px}
    .badge-stop{background:#fee2e2;color:#b91c1c}
    .badge-go{background:#dcfce7;color:#166534}
    .progress-wrap{height:8px;background:#f1f5f9;border-radius:9999px;overflow:hidden}
    .progress-bar{height:100%;background:var(--yellow);width:0}
    .sortable{cursor:pointer; user-select:none; white-space:nowrap;}
    .sortable .arrow { opacity:.45; margin-left:6px; }
    .sortable[aria-sort="ascending"] .arrow::after  { content:'▲'; }
    .sortable[aria-sort="descending"] .arrow::after { content:'▼'; }
    .metric-card{
      background:#fff;border-radius:16px;box-shadow:0 8px 28px rgba(15,23,42,.10);
      padding:18px 20px;display:flex;align-items:center;gap:14px;
      transition:transform .15s ease, box-shadow .15s ease;cursor:pointer;
    }
    .metric-card:hover{ transform:translateY(-2px); box-shadow:0 12px 32px rgba(15,23,42,.12); }
    .metric-icon{ width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center; }
    .metric-title{font-size:14px;color:#6b7280}
    .metric-value{font-size:30px;font-weight:700;color:#111827;line-height:1}
    .icon-blue { background:#e0ecff;color:#3973ff }
    .icon-green{ background:#e8f9ef;color:#16a34a }
    .icon-amber{ background:#fff2cc;color:#d97706 }
    .icon-red  { background:#ffe4e6;color:#ef4444 }

    .table-scroll {
      max-height: 520px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
    }
    thead.sticky-top { position: sticky; top: 0; z-index: 5; }

    @media (max-width: 768px) {
      .container { padding-left: 1rem; padding-right: 1rem; }
      .tab-btn { font-size: 0.75rem; padding: 0.5rem; }
      .metric-value { font-size: 24px; }
      .metric-title { font-size: 12px; }
      .metric-icon { width: 40px; height: 40px; }
      .metric-card { padding: 14px 16px; }
      table { font-size: 0.8rem; }
      th, td { padding: 0.5rem 0.25rem; }
      .progress-wrap { height: 6px; }
    }
    .ui-datepicker { font-size:0.9rem; width:17em; }
    .ui-datepicker .ui-datepicker-header { padding:0.3em 0; }
    .ui-datepicker .ui-datepicker-title { font-size:0.9rem; }
    .ui-datepicker th { font-size:0.8rem; padding:0.3em; }
    .ui-datepicker td { padding:0; }
    .ui-datepicker td a, .ui-datepicker td span { padding:0.3em; }

    @media (max-width: 768px) {
      #edit-modal .bg-white { margin:1rem;width:calc(100% - 2rem); }
    }

    .vendor-capture-container { background: white; padding: 20px; border-radius: 8px; }
    .vendor-capture-title { text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 15px; }
    .vendor-capture-date { text-align: center; font-size: 12px; margin-bottom: 20px; color: #666; }
    .vendor-filter-container { background-color: #f9fafb; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    .vendor-filter-title { font-weight: 600; margin-bottom: 8px; color: #374151; }
  </style>
</head>
<body class="min-h-full">
  <div class="container mx-auto px-4 py-4 md:py-8 max-w-7xl">
    <div class="mb-4">
      <a href="index.html" class="inline-flex items-center bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition duration-300">
        <i class="fas fa-arrow-left mr-2"></i> Kembali
      </a>
    </div>

    <header class="mb-6 md:mb-8 text-center">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">Aplikasi HP – Versi Pro</h1>
      <p class="text-gray-600 text-sm md:text-base">Sistem Manajemen Data Handphone Karyawan</p>
    </header>

    <div class="flex border-b border-gray-200 mb-4 md:mb-6 overflow-x-auto">
      <button class="tab-btn px-3 py-2 md:px-4 font-medium text-sm border-b-2 border-yellow-500 text-yellow-600 whitespace-nowrap" data-tab="input">
        <i class="fas fa-plus-circle mr-1 md:mr-2"></i>Input Data
      </button>
      <button class="tab-btn px-3 py-2 md:px-4 font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="data">
        <i class="fas fa-table mr-1 md:mr-2"></i>Data HP
      </button>
      <button class="tab-btn px-3 py-2 md:px-4 font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="vendor">
        <i class="fas fa-truck mr-1 md:mr-2"></i>Vendor
      </button>
      <button class="tab-btn px-3 py-2 md:px-4 font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="compare">
        <i class="fas fa-balance-scale mr-1 md:mr-2"></i>Pembanding Vendor
      </button>
      <button class="tab-btn px-3 py-2 md:px-4 font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="dashboard">
        <i class="fas fa-chart-bar mr-1 md:mr-2"></i>Dashboard
      </button>
      <button class="tab-btn px-3 py-2 md:px-4 font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap" data-tab="settings">
        <i class="fas fa-cog mr-1 md:mr-2"></i>Pengaturan
      </button>
    </div>

    <section id="input-section" class="tab-content">
      <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
        <h2 class="text-lg md:text-xl font-semibold mb-4 text-gray-800">Input Data HP Baru</h2>

        <div id="angsuran-warning-input" class="hidden mb-4 rounded-md border border-yellow-300 bg-yellow-50 p-3 text-yellow-800">
          <div class="flex items-start gap-3">
            <i class="fas fa-triangle-exclamation mt-0.5"></i>
            <div>
              <div class="font-semibold">NPK ini masih memiliki angsuran aktif</div>
              <div class="text-sm">Sistem mendeteksi ada cicilan yang belum selesai untuk NPK ini. Pastikan data yang diinput benar.</div>
              <div id="angsuran-list" class="mt-2 text-xs text-yellow-900"></div>
              <label class="mt-2 inline-flex items-center gap-2 text-sm">
                <input type="checkbox" id="angsuran-ack-input" class="h-4 w-4 rounded border-gray-300">
                <span>Saya paham, lanjutkan</span>
              </label>
            </div>
          </div>
        </div>

        <form id="input-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
            <input type="text" id="tanggal" class="tanggal-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">NPK</label>
            <input type="text" id="npk" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">No. Telp</label>
            <input type="text" id="notelp" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cicilan (bulan)</label>
            <input type="number" id="cicilan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" min="1" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipe HP</label>
            <select id="tipehp" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
              <option value="">Pilih Tipe HP</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Kirim</label>
            <input type="text" id="alamat" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <option value="">Pilih Status</option>
              <option>OK</option><option>CANCEL</option><option>NO ACC</option><option>VERIFIKASI</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
            <input type="text" id="keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
          </div>
          <div class="md:col-span-2">
            <button id="btn-submit" type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-md transition duration-300">
              <i class="fas fa-save mr-2"></i>Simpan Data
            </button>
          </div>
        </form>
      </div>
    </section>

    <section id="data-section" class="tab-content section-hidden">
      <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
          <h2 class="text-lg md:text-xl font-semibold text-gray-800 mb-2 md:mb-0">Data HP Karyawan</h2>
          <div class="flex flex-wrap gap-2">
            <button id="refresh-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-sync-alt mr-1"></i> Refresh
            </button>
            <button id="export-excel-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-file-excel mr-1"></i> Excel
            </button>
            <button id="export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-file-pdf mr-1"></i> PDF
            </button>
            <div class="relative">
              <input type="text" id="search-input" placeholder="Cari data..." class="pl-8 pr-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <i class="fas fa-search absolute left-2 top-2 text-gray-400"></i>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Urutkan Tanggal</label>
            <select id="sort-tanggal" class="w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <option value="asc">Terlama ke Terbaru</option>
              <option value="desc">Terbaru ke Terlama</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Filter Status</label>
            <select id="filter-status" class="w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <option value="">Semua Status</option>
              <option>OK</option><option>CANCEL</option><option>NO ACC</option><option>VERIFIKASI</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Awal</label>
            <input type="text" id="filter-tanggal-awal" class="tanggal-input w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
            <input type="text" id="filter-tanggal-akhir" class="tanggal-input w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
          </div>
        </div>
        <div class="table-scroll">
          <table id="data-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky-top">
              <tr>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-col="id" aria-sort="none">ID <span class="arrow"></span></th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-col="tanggal" aria-sort="ascending">Tanggal <span class="arrow"></span></th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-col="npk" aria-sort="none">NPK <span class="arrow"></span></th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-col="nama" aria-sort="none">Nama <span class="arrow"></span></th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-col="notelp" aria-sort="none">No. Telp <span class="arrow"></span></th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-col="tipehp" aria-sort="none">Tipe HP <span class="arrow"></span></th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-col="cicilan" aria-sort="none">Cicilan <span class="arrow"></span></th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-col="status" aria-sort="none">Status <span class="arrow"></span></th>
                <th class="sortable px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" data-col="masa" aria-sort="none">Masa Cicilan <span class="arrow"></span></th>
                <th class="px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
        <div class="mt-3 text-sm text-gray-700">
          Menampilkan <span id="showing-count">0</span> dari <span id="total-count">0</span> data
        </div>
      </div>
    </section>

    <section id="vendor-section" class="tab-content section-hidden">
      <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
          <h2 class="text-lg md:text-xl font-semibold text-gray-800 mb-2 md:mb-0">Data Vendor (Semua Data)</h2>
          <div class="flex flex-wrap gap-2">
            <button id="vendor-refresh-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-sync-alt mr-1"></i> Refresh
            </button>
            <button id="vendor-export-excel-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-file-excel mr-1"></i> Excel
            </button>
            <button id="vendor-export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-file-pdf mr-1"></i> PDF
            </button>
            <button id="vendor-export-jpeg-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-file-image mr-1"></i> JPEG
            </button>
            <div class="relative">
              <input type="text" id="vendor-search-input" placeholder="Cari (NPK/Nama/Telp/Tipe/Alamat)..." class="pl-8 pr-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <i class="fas fa-search absolute left-2 top-2 text-gray-400"></i>
            </div>
          </div>
        </div>
        <div class="vendor-filter-container">
          <div class="vendor-filter-title">Filter Data Vendor</div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Urutkan Tanggal</label>
              <select id="vendor-sort-tanggal" class="w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <option value="desc">Terbaru ke Terlama</option>
                <option value="asc">Terlama ke Terbaru</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Filter Tipe HP</label>
              <select id="vendor-filter-tipehp" class="w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <option value="">Semua Tipe</option>
                <option value="VIVO">VIVO</option><option value="REDMI">REDMI</option>
                <option value="OPPO">OPPO</option><option value="REALME">REALME</option>
                <option value="SAMSUNG">SAMSUNG</option><option value="LAINNYA">LAINNYA</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Filter Status</label>
              <select id="vendor-filter-status" class="w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
                <option value="">Semua Status</option>
                <option value="OK">OK</option><option value="CANCEL">CANCEL</option><option value="NO ACC">NO ACC</option><option value="VERIFIKASI">VERIFIKASI</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Awal</label>
              <input type="text" id="vendor-tanggal-awal" class="tanggal-input w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
              <input type="text" id="vendor-tanggal-akhir" class="tanggal-input w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
            </div>
            <div class="lg:col-span-1 flex items-end">
              <button id="vendor-clear-filter" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-md text-sm transition duration-300 w-full">
                <i class="fas fa-eraser mr-1"></i> Bersihkan Filter
              </button>
            </div>
          </div>
        </div>
        <div class="table-scroll">
          <table id="vendor-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky-top">
              <tr>
                <th class="px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                <th class="px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NPK</th>
                <th class="px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                <th class="px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Telp</th>
                <th class="px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipe</th>
                <th class="px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-2 md:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alamat Kirim</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
        <div class="mt-3 text-sm text-gray-700">
          Menampilkan <span id="vendor-showing-count">0</span> dari <span id="vendor-total-count">0</span> data
        </div>
      </div>
    </section>

    <section id="compare-section" class="tab-content section-hidden">
      <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
          <h2 class="text-lg md:text-xl font-semibold text-gray-800 mb-2 md:mb-0">Pembanding Harga Vendor Karyawan</h2>
          <div class="flex flex-wrap gap-2">
            <button id="compare-export-excel-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-file-excel mr-1"></i> Excel
            </button>
            <button id="compare-export-pdf-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-file-pdf mr-1"></i> PDF
            </button>
            <button id="compare-export-jpeg-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-file-image mr-1"></i> JPEG
            </button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Awal</label>
            <input type="text" id="compare-tanggal-awal" class="tanggal-input w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Akhir</label>
            <input type="text" id="compare-tanggal-akhir" class="tanggal-input w-full px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
          </div>
          <div class="flex items-end">
            <button id="compare-clear-filter" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-md text-sm transition duration-300">
              <i class="fas fa-eraser mr-1"></i> Bersihkan Filter
            </button>
          </div>
        </div>
        <div class="table-scroll">
          <table id="compare-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky-top">
              <tr>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">NPK</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipe HP</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Merek</th>
                <th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
        <div class="mt-3 text-sm text-gray-700">
          Menampilkan <span id="compare-count">0</span> baris
        </div>
      </div>
    </section>

    <section id="dashboard-section" class="tab-content section-hidden">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-6">
        <div id="card-total" class="metric-card" role="button" tabindex="0" data-qfilter="ALL" aria-label="Total HP">
          <div class="metric-icon icon-blue"><i class="fas fa-mobile-screen-button"></i></div>
          <div><div class="metric-title">Total HP</div><div id="total-hp" class="metric-value">0</div></div>
        </div>
        <div id="card-ok" class="metric-card" role="button" tabindex="0" data-qfilter="OK" aria-label="Status OK">
          <div class="metric-icon icon-green"><i class="fas fa-check"></i></div>
          <div><div class="metric-title">Status OK</div><div id="status-ok" class="metric-value">0</div></div>
        </div>
        <div id="card-proses" class="metric-card" role="button" tabindex="0" data-qfilter="PROSES" aria-label="Dalam Proses">
          <div class="metric-icon icon-amber"><i class="fas fa-hourglass-half"></i></div>
          <div><div class="metric-title">Dalam Proses</div><div id="status-proses" class="metric-value">0</div></div>
        </div>
        <div id="card-issues" class="metric-card" role="button" tabindex="0" data-qfilter="ISSUES" aria-label="Bermasalah">
          <div class="metric-icon icon-red"><i class="fas fa-xmark"></i></div>
          <div><div class="metric-title">Bermasalah</div><div id="status-issues" class="metric-value">0</div></div>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
          <h3 class="text-lg font-semibold mb-4 text-gray-800">Distribusi Tipe HP</h3>
          <div class="h-64"><canvas id="tipe-hp-chart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
          <h3 class="text-lg font-semibold mb-4 text-gray-800">Status HP</h3>
          <div class="h-64"><canvas id="status-chart"></canvas></div>
        </div>
      </div>
    </section>

    <section id="settings-section" class="tab-content section-hidden">
    <!-- Perbaikan Vendor -->
    <div class="mb-6">
      <h3 class="text-md font-medium mb-2 text-gray-700">Perbaikan Vendor</h3>
      <p class="text-sm text-gray-600 mb-3">
        Buka halaman untuk memperbaiki/menyesuaikan data vendor.
      </p>
      <a href="vendor.html"
         class="inline-flex items-center bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md transition duration-300">
        <span class="fa-solid fa-screwdriver-wrench mr-2"></span>
        Perbaikan Vendor
      </a>
    </div>

      <div class="bg-white rounded-lg shadow-md p-4 md:p-6 mb-6">
        <h2 class="text-lg md:text-xl font-semibold mb-4 text-gray-800">Pengaturan Aplikasi</h2>
        <div class="mb-6">
          <h3 class="text-md font-medium mb-2 text-gray-700">Refresh Data</h3>
          <p class="text-sm text-gray-600 mb-3">Refresh semua data perhitungan masa cicilan</p>
          <button id="refresh-all-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition duration-300">
            <i class="fas fa-sync-alt mr-2"></i>Refresh Semua Data
          </button>
        </div>
        <div class="mb-6">
          <h3 class="text-md font-medium mb-2 text-gray-700">Tentang Aplikasi</h3>
          <div class="bg-gray-50 p-4 rounded-md">
            <p class="text-sm text-gray-700 mb-2"><strong>Nama Aplikasi:</strong> Aplikasi HP – Versi Pro</p>
            <p class="text-sm text-gray-700 mb-2"><strong>Versi:</strong> 2025.08.22</p>
            <p class="text-sm text-gray-700"><strong>Deskripsi:</strong> Sistem manajemen data handphone karyawan dengan fitur pencatatan, monitoring, dan pelaporan.</p>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-screen overflow-y-auto">
      <div class="p-4 md:p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg md:text-xl font-semibold text-gray-800">Edit Data HP</h3>
          <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
        </div>
        <form id="edit-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="edit-id">
          <input type="hidden" id="edit-row">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
            <input type="text" id="edit-tanggal" class="tanggal-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">NPK</label>
            <input type="text" id="edit-npk" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">No. Telp</label>
            <input type="text" id="edit-notelp" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cicilan (bulan)</label>
            <input type="number" id="edit-cicilan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" min="1" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Tipe HP</label>
            <select id="edit-tipehp" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
              <option value="">Pilih Tipe HP</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Kirim</label>
            <input type="text" id="edit-alamat" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="edit-status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
              <option value="">Pilih Status</option>
              <option>OK</option><option>CANCEL</option><option>NO ACC</option><option>VERIFIKASI</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label>
            <input type="text" id="edit-keterangan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Stop Mulai</label>
            <input type="text" id="edit-stop-mulai" class="tanggal-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Lanjut Mulai</label>
            <input type="text" id="edit-lanjut-mulai" class="tanggal-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="DD/MM/YYYY">
          </div>
          <div class="md:col-span-2">
            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-md transition duration-300">
              <i class="fas fa-save mr-2"></i>Update Data
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="notification" class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 max-w-md transform transition-transform duration-300 translate-y-20 opacity-0 flex items-start">
    <div id="notification-icon" class="mr-3 mt-1"></div>
    <div>
      <h4 id="notification-title" class="font-medium text-gray-800"></h4>
      <p id="notification-message" class="text-sm text-gray-600 mt-1"></p>
    </div>
    <button id="close-notification" class="ml-4 text-gray-400 hover:text-gray-600">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <script>
    // =================================== KONFIGURASI APLIKASI ===================================
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbzfADC35kj6zXB9cH2ilyZtnvLV060wnB-ZECOzlnbW83XTgopFc_-JMFp9L-xjr1gj/exec';
    const PRICE_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzu40FgK2o8iCSTN9r1lBWhSy84wkLbqo_9vtIP-L6qbPG-KIkRf22BIkL5mVFgxvnRIQ/exec';

    // Dynamic vendor labels (loaded from PRICE_ENDPOINT)
    let VENDOR_LABEL_ALF = 'Alfacell';
    let VENDOR_LABEL_SA  = 'Sentral Abadi Jaya';
    
    // =================================== PENGECEKAN AKSES ADMIN ===================================
    (function enforceAdmin(){
      const qsUser = new URLSearchParams(location.search).get('user') || '';
      const ssUser = sessionStorage.getItem('username') || '';
      const USERNAME = (ssUser || qsUser || '').trim();
      if ((USERNAME || '').toLowerCase() !== 'adminksn') {
        alert('Akses ditolak! Hanya adminksn yang bisa membuka halaman ini.');
        window.location.href = 'index.html';
      }
    })();

    // =================================== VARIABEL GLOBAL UNTUK DATA & STATE ===================================
    let allData = [];
    let filteredData = [];
    let sortColumn = 'tanggal';
    let sortDirection = 'asc';
    let tipeHpChart = null, statusChart = null;
    let vendorData = [];
    let vendorFiltered = [];
    
    // DB HARGA VENDOR (DINAMIS DARI PRICE_ENDPOINT)
    let vendorPrices = { alfacell: [], sentral: [] };
    let vendorIndex  = { alfacell: new Map(), sentral: new Map() };
    let priceReady = false;

    // =================================== FUNGSI-FUNGSI UTAMA UNTUK OPERASI DATA ===================================

    function loadData(){
      showNotification('info','Memuat Data','Mengambil data dari server...');
      $.getJSON(ENDPOINT, { action:'getAll' })
        .done(res => {
          if (res.status === 'success') {
            allData = res.data || [];
            filterData();
            syncVendorFromAll();
            showNotification('success','Berhasil','Data berhasil dimuat');
            const npk = ($('#npk').val() || '').trim();
            if (npk) checkAngsuranOnInput(npk);
          } else {
            showNotification('error','Gagal', res.message || 'Kesalahan saat memuat data');
          }
        })
        .fail(() => showNotification('error','Kesalahan','Tidak dapat terhubung ke server'));
    }

    function submitForm(){
      if (!$('#angsuran-warning-input').hasClass('hidden') && !$('#angsuran-ack-input').is(':checked')) {
        showNotification('warning','Tindakan Diblokir','Centang "Saya paham, lanjutkan" sebelum menyimpan.');
        return;
      }
      const data = {
        tanggal: $('#tanggal').val(),
        npk: $('#npk').val(),
        notelp: $('#notelp').val(),
        cicilan: $('#cicilan').val(),
        tipehp: $('#tipehp').val(),
        alamat: $('#alamat').val(),
        keterangan: $('#keterangan').val(),
        status: $('#status').val()
      };
      showNotification('info','Menyimpan','Mengirim data...');
      $.post(ENDPOINT, data, null, 'json')
        .done(res => {
          if (res.status === 'success') {
            $('#input-form')[0].reset();
            hideAngsuranWarning();
            loadData();
            showNotification('success','Berhasil','Data disimpan');
          } else {
            showNotification('error','Gagal', res.message || 'Kesalahan menyimpan data');
          }
        })
        .fail(()=>showNotification('error','Kesalahan','Tidak dapat terhubung ke server'));
    }

    function updateData(){
      const data = {
        action:'updateData',
        id: $('#edit-id').val(),
        row: $('#edit-row').val(),
        tanggal: $('#edit-tanggal').val(),
        npk: $('#edit-npk').val(),
        notelp: $('#edit-notelp').val(),
        cicilan: $('#edit-cicilan').val(),
        tipehp: $('#edit-tipehp').val(),
        alamat: $('#edit-alamat').val(),
        keterangan: $('#edit-keterangan').val(),
        status: $('#edit-status').val(),
        stop_mulai: $('#edit-stop-mulai').val(),
        lanjut_mulai: $('#edit-lanjut-mulai').val()
      };
      showNotification('info','Memperbarui','Mengirim perubahan...');
      $.post(ENDPOINT, data, null, 'json')
        .done(res => {
          if (res.status === 'success') {
            $('#edit-modal').addClass('hidden');
            loadData();
            showNotification('success','Berhasil','Data diperbarui');
          } else {
            showNotification('error','Gagal', res.message || 'Kesalahan memperbarui data');
          }
        })
        .fail(()=>showNotification('error','Kesalahan','Tidak dapat terhubung ke server'));
    }

    function refreshAllData(){
      showNotification('info','Refresh','Memproses perhitungan ulang...');
      $.post(ENDPOINT, { action:'refreshAll' }, null, 'json')
        .done(res => {
          if (res.status === 'success') { loadData(); showNotification('success','Berhasil', res.message || 'Data direfresh'); }
          else { showNotification('error','Gagal', res.message || 'Kesalahan saat refresh'); }
        })
        .fail(()=>showNotification('error','Kesalahan','Tidak dapat terhubung ke server'));
    }

    // =================================== FUNGSI-FUNGSI PEMBANTU (HELPERS) ===================================
    function showNotification(type,title,message){
      const n = $('#notification'), icon = $('#notification-icon'), t=$('#notification-title'), m=$('#notification-message');
      icon.empty();
      if(type==='success') icon.append('<i class="fas fa-check-circle text-green-500 text-xl"></i>');
      else if(type==='error') icon.append('<i class="fas fa-exclamation-circle text-red-500 text-xl"></i>');
      else if(type==='warning') icon.append('<i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>');
      else icon.append('<i class="fas fa-info-circle text-blue-500 text-xl"></i>');
      t.text(title); m.text(message);
      n.removeClass('translate-y-20 opacity-0');
      setTimeout(()=>n.addClass('translate-y-20 opacity-0'), 5000);
    }
    
    function isAndroidWebView(){
      const ua = navigator.userAgent || '';
      return /Android/i.test(ua) && /wv|Version\/\d+\.\d+ Chrome\/\d+.*Mobile Safari\/\d+/i.test(ua);
    }

    async function downloadBlob(blob, name){
      try { if (typeof saveAs === 'function' && !isAndroidWebView()) { saveAs(blob, name); return; } } catch(e){}
      try {
        const dataUrl = await new Promise((resolve, reject) => {
          const r = new FileReader(); r.onloadend = () => resolve(r.result); r.onerror = reject; r.readAsDataURL(blob);
        });
        const a = document.createElement('a');
        if ('download' in a){ a.href = dataUrl; a.download = name; document.body.appendChild(a); a.click(); a.remove(); return; }
        window.location.href = dataUrl; return;
      } catch(err) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 1500);
      }
    }

    function parseDate(s){
      if(!s) return null; const p = String(s).split('/'); if(p.length!==3) return null;
      return new Date(parseInt(p[2],10), parseInt(p[1],10)-1, parseInt(p[0],10));
    }

    function parseMasaCicilan(s){
      if (!s) return {cur:null, tot:null};
      const m = String(s).trim().match(/^(\d+)\s*\/\s*(\d+)$/);
      if (!m) return {cur:null, tot:null};
      return {cur:parseInt(m[1],10), tot:parseInt(m[2],10)};
    }

    function checkAngsuranOnInput(npk){
      const warn = $('#angsuran-warning-input'), list = $('#angsuran-list'), ack = $('#angsuran-ack-input');
      if (!npk) { hideAngsuranWarning(); return; }
      const aktif = (allData||[]).filter(d=>{
        if (!d || (String(d.npk||'').trim() !== npk)) return false;
        const {cur, tot} = parseMasaCicilan(d.masaCicilan || '');
        if (cur===null || tot===null) return false;
        const st = (d.status || '').toUpperCase();
        return !['CANCEL','NO ACC'].includes(st) && cur < tot;
      });
      if (aktif.length){
        const rows = aktif.slice(0,5).map(a=>`<div>• ${a.masaCicilan||'-'} – ${a.tipehp||'-'} (Tgl: ${a.tanggal||'-'})</div>`).join('');
        list.html(rows + (aktif.length>5 ? `<div class="italic">+ ${aktif.length-5} data lagi...</div>` : ''));
        warn.removeClass('hidden'); ack.prop('checked', false); toggleSubmitDisabled(true);
      } else { hideAngsuranWarning(); }
    }

    function hideAngsuranWarning(){
      $('#angsuran-warning-input').addClass('hidden');
      $('#angsuran-ack-input').prop('checked', false);
      toggleSubmitDisabled(false);
    }

    function toggleSubmitDisabled(dis){
      $('#btn-submit').prop('disabled', dis).toggleClass('opacity-50 cursor-not-allowed', dis);
    }

    // =================================== FUNGSI KHUSUS HARGA VENDOR ===================================
    function normName(s){
      return (s||'')
        .toString()
        .toUpperCase()
        .replace(/GB\b/g,'')
        .replace(/[\(\)\[\]\.]/g, ' ')
        .replace(/\s*\+\s*/g, ' ')
        .replace(/\s*\/\s*/g, ' ')
        .replace(/[^A-Z0-9 ]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }
    
    function getHargaFast(which, typeName){
      const key = normName(typeName);
      const map = vendorIndex[which];

      if (map.has(key)) return map.get(key);

      const tok = key.split(' ');
      let bestV = null, bestScore = 0;
      for (const [k, v] of map.entries()){
        const inter = tok.filter(t => k.includes(t)).length;
        if (inter > bestScore){ bestScore = inter; bestV = v; }
      }
      return bestScore >= 2 ? bestV : null;
    }
    
    function buildPriceIndex(){
      vendorIndex.alfacell.clear();
      vendorIndex.sentral.clear();
      vendorPrices.alfacell.forEach(it => vendorIndex.alfacell.set(normName(it.nama), it.harga));
      vendorPrices.sentral.forEach(it  => vendorIndex.sentral.set(normName(it.nama),  it.harga));
    }

    async function loadPriceDB(){
      showNotification('info', 'Memuat Harga', 'Mengambil database harga vendor...');
      try{
        const url = PRICE_ENDPOINT.includes('?') ? PRICE_ENDPOINT : PRICE_ENDPOINT + '?action=all';
        const res = await fetch(url, { cache:'no-store' });
        const json = await res.json();
        const rows = Array.isArray(json?.data) ? json.data
                   : Array.isArray(json?.rows) ? json.rows
                   : Array.isArray(json)        ? json
                   : [];

        
        // Pick up vendor labels if provided by API
        try {
          const vl = json?.vendorLabels || json?.vendorlabels || null;
          if (vl) {
            if (vl.name_alf) VENDOR_LABEL_ALF = String(vl.name_alf);
            if (vl.name_sa)  VENDOR_LABEL_SA  = String(vl.name_sa);
          } else {
            // Fallback: try querying config endpoint to fetch labels
            try {
              const resCfg = await fetch(PRICE_ENDPOINT + (PRICE_ENDPOINT.includes('?') ? '&' : '?') + 'action=config', { cache:'no-store' });
              const cfg = await resCfg.json();
              const vendors = cfg?.vendors || cfg?.data?.vendors || null;
              if (vendors) {
                if (vendors.name_alf) VENDOR_LABEL_ALF = String(vendors.name_alf);
                if (vendors.name_sa)  VENDOR_LABEL_SA  = String(vendors.name_sa);
              }
            } catch (e) { /* silent */ }
          }
        } catch(e){ /* ignore labels error */ }
    vendorPrices = { alfacell: [], sentral: [] };
        rows.forEach(r=>{
          const tipe  = String(r['tipe'] || r['TIPE BARANG'] || '').trim();
          const merek = String(r['merek'] || r['MEREK'] || '').trim().toUpperCase();
          const hA = r['harga_alfafcell'] ?? r['HARGA_ALFAFCELL'] ?? null;
          const hS = r['harga_sentral_abadi'] ?? r['HARGA_SENTRAL ABADI'] ?? r['HARGA_SENTRAL_ABADI'] ?? null;
          const toNum = v => {
            if (v === null || v === undefined || v === '') return null;
            if (typeof v === 'number') return v;
            const s = String(v).replace(/[^\d.-]/g,'');
            const n = Number(s); return Number.isFinite(n) ? n : null;
          };
          const numHA = toNum(hA);
          const numHS = toNum(hS);
          if (tipe){
            if (numHA != null) vendorPrices.alfacell.push({ nama: tipe, merek, harga: numHA });
            if (numHS != null) vendorPrices.sentral.push({  nama: tipe, merek, harga: numHS });
          }
        });
        buildPriceIndex();
        
        if (vendorPrices.alfacell.length === 0 && vendorPrices.sentral.length === 0) {
          showNotification(
            'warning',
            'DB Harga Kosong',
            'PRICE_ENDPOINT tidak mengembalikan data atau nama kolom tidak cocok. Pastikan kolom: TIPE BARANG, MEREK, HARGA_ALFAFCELL, HARGA_SENTRAL ABADI.'
          );
          console.warn('Harga vendor kosong. Cek struktur JSON dari PRICE_ENDPOINT.');
          priceReady = false;
        } else {
          priceReady = true;
          showNotification('success', 'Harga Dimuat', 'Database harga vendor berhasil dimuat.');
        }

        populateTipeOptionsFromPriceDB(rows);
        console.log('Vendor price DB loaded:', vendorPrices);
      } catch(err){
        priceReady = false;
        console.warn('Gagal memuat PRICE_ENDPOINT. Cek koneksi atau URL.', err);
        showNotification('error', 'Gagal Memuat Harga', 'Tidak dapat terhubung ke database harga vendor.');
      }
    }

    function populateTipeOptionsFromPriceDB(rows){
      const getTipes = () => {
        const set = new Set();
        rows.forEach(r=>{
          const t = String(r['TIPE BARANG'] || r['tipe'] || r['Tipe'] || r['TIPE'] || '').trim();
          if (t) set.add(t);
        });
        return Array.from(set).sort((a,b)=>a.localeCompare(b));
      };
      const tipes = getTipes();
      if (!tipes.length) return;
      const fill = ($sel) => {
        if ($sel.find('option').length > 5 && $sel.find('option[value!=""]').length > 1) return;
        $sel.empty().append('<option value="">Pilih Tipe HP</option>');
        tipes.forEach(t => $sel.append(`<option>${t}</option>`));
        $sel.append('<option>LAINNYA</option>');
      };
      fill($('#tipehp'));
      fill($('#edit-tipehp'));
    }

    // =================================== FUNGSI TAB DATA HP ===================================
    function filterData(){
      const q = ($('#search-input').val() || '').toLowerCase();
      const status = $('#filter-status').val();
      const tAwal = $('#filter-tanggal-awal').val();
      const tAkhir = $('#filter-tanggal-akhir').val();
      filteredData = (allData || []).filter(item => {
        let ok = true;
        if (tAwal) { const a = parseDate(tAwal), t = parseDate(item.tanggal); ok = ok && (!a || (t && t >= a)); }
        if (tAkhir) { const b = parseDate(tAkhir); if (b) b.setHours(23,59,59,999); const t = parseDate(item.tanggal); ok = ok && (!b || (t && t <= b)); }
        if (status) ok = ok && ((item.status || '') === status);
        if (q) {
          ok = ok && (
            (item.npk||'').toLowerCase().includes(q) || (item.nama||'').toLowerCase().includes(q) ||
            (item.notelp||'').toLowerCase().includes(q) || (item.tipehp||'').toLowerCase().includes(q) ||
            (item.status||'').toLowerCase().includes(q) || (item.keterangan||'').toLowerCase().includes(q)
          );
        }
        return ok;
      });
      sortData();
      renderTable();
      updateDashboardCounters();
    }

    function getSortValue(it, col){
      switch(col){
        case 'id':     return parseInt(it.id || it.row || 0, 10) || 0;
        case 'tanggal':return parseDate(it.tanggal) || new Date(0);
        case 'npk':    return (it.npk || '').toString().toLowerCase();
        case 'nama':   return (it.nama || '').toString().toLowerCase();
        case 'notelp': return (it.notelp || '').toString().toLowerCase();
        case 'tipehp': return (it.tipehp || '').toString().toLowerCase();
        case 'cicilan':return parseInt(it.cicilan || 0, 10) || 0;
        case 'status': return (it.status || '').toString().toLowerCase();
        case 'masa': { const p = parseMasaCicilan(it.masaCicilan || ''); return (p && p.tot) ? (p.cur / p.tot) : -1; }
        default: return '';
      }
    }

    function sortData(){
      filteredData.sort((a,b)=>{
        const A = getSortValue(a, sortColumn);
        const B = getSortValue(b, sortColumn);
        if (A < B) return sortDirection==='asc' ? -1 : 1;
        if (A > B) return sortDirection==='asc' ? 1 : -1;
        return 0;
      });
    }

    function updateSortIndicators(){
      $('#data-table th.sortable').attr('aria-sort', 'none');
      $('#data-table th.sortable').each(function(){
        const col = $(this).data('col');
        if (col === sortColumn){
          $(this).attr('aria-sort', sortDirection === 'asc' ? 'ascending' : 'descending');
        }
      });
    }

    function thSortHandler(){
      const col = $(this).data('col');
      if (!col) return;
      if (sortColumn === col) {
        sortDirection = (sortDirection === 'asc') ? 'desc' : 'asc';
      } else {
        sortColumn = col;
        sortDirection = (col === 'tanggal') ? $('#sort-tanggal').val() : 'asc';
      }
      if (col === 'tanggal') $('#sort-tanggal').val(sortDirection);
      updateSortIndicators();
      sortData();
      renderTable();
    }

    function renderTable(){
      const $tbody = $('#data-table tbody').empty();
      if (!filteredData.length){
        $tbody.append('<tr><td colspan="10" class="px-4 py-4 text-center text-gray-500">Tidak ada data yang tersedia</td></tr>');
      } else {
        filteredData.forEach(item=>{
          const phoneDigits = normalizeTo62(item.notelp);
          const waLink = phoneDigits
            ? `<a href="https://wa.me/${phoneDigits}" target="_blank" rel="noopener noreferrer" class="whatsapp-link hover:underline">${item.notelp || ''}</a>`
            : (item.notelp || '');
          let statusBadge = '';
          if (item.status==='OK') statusBadge = '<span class="badge badge-go"><i class="fas fa-check-circle"></i> OK</span>';
          else if (['CANCEL','NO ACC'].includes(item.status)) statusBadge = `<span class="badge badge-stop"><i class="fas fa-times-circle"></i> ${item.status}</span>`;
          else if (item.status==='VERIFIKASI') statusBadge = '<span class="badge" style="background:#fef3c7;color:#92400e"><i class="fas fa-exclamation-circle"></i> VERIFIKASI</span>';
          else statusBadge = '<span class="badge" style="background:#f3f4f6;color:#4b5563"><i class="fas fa-question-circle"></i> -</span>';
          const masa = (()=> {
            if (!item.masaCicilan) return '<div class="text-sm text-gray-500">-</div>';
            const p = parseMasaCicilan(item.masaCicilan);
            const cur = p.cur ?? 0, tot = p.tot ?? 0;
            const perc = tot>0 ? Math.min(100, Math.round((cur/tot)*100)) : 0;
            const warnIcon = (p.cur!==null && p.tot!==null && cur < tot)
              ? '<i class="fas fa-triangle-exclamation ml-2 text-yellow-500" title="Masih ada angsuran"></i>' : '';
            return `<div class="text-sm flex items-center">${item.masaCicilan}${warnIcon}</div>
                    <div class="progress-wrap mt-1"><div class="progress-bar" style="width:${perc}%"></div></div>`;
          })();
          const tr = `<tr>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.id || item.row || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.tanggal || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.npk || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.nama || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${waLink}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.tipehp || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${item.cicilan || ''}</td>
            <td class="px-2 md:px-4 py-3 text-sm">${statusBadge}</td>
            <td class="px-2 md:px-4 py-3">${masa}</td>
            <td class="px-2 md:px-4 py-3 text-sm">
              <button class="text-blue-500 hover:text-blue-700 mr-3 edit-btn" data-id="${item.id}" data-row="${item.row}">
                <i class="fas fa-edit"></i>
              </button>
            </td>
          </tr>`;
          $tbody.append(tr);
        });
        $('.edit-btn').on('click', function(){ editData($(this).data('id'), $(this).data('row')); });
      }
      $('#showing-count').text(filteredData.length);
      $('#total-count').text(allData.length);
    }

    function editData(id,row){
      const it = allData.find(d => (d.id && d.id==id) || (d.row && d.row==row));
      if (!it) return;
      $('#edit-id').val(it.id || '');
      $('#edit-row').val(it.row || '');
      $('#edit-tanggal').val(it.tanggal || '');
      $('#edit-npk').val(it.npk || '');
      $('#edit-notelp').val(it.notelp || '');
      $('#edit-cicilan').val(it.cicilan || '');
      $('#edit-tipehp').val(it.tipehp || '');
      $('#edit-alamat').val(it.alamat || '');
      $('#edit-keterangan').val(it.keterangan || '');
      $('#edit-status').val(it.status || '');
      $('#edit-stop-mulai').val(it.stopMulai || '');
      $('#edit-lanjut-mulai').val(it.lanjutMulai || '');
      $('#edit-modal').removeClass('hidden');
    }
    
    async function exportToExcel(){
      if (!filteredData.length) { showNotification('warning','Peringatan','Tidak ada data untuk diekspor'); return; }
      showNotification('info','Ekspor','Menyiapkan Excel...');
      const tA = $('#filter-tanggal-awal').val() || 'Awal';
      const tB = $('#filter-tanggal-akhir').val() || 'Akhir';
      const sF = $('#filter-status').val() || 'Semua';
      const d = new Date(); const ds = `${String(d.getDate()).padStart(2,'0')}${String(d.getMonth()+1).padStart(2,'0')}${d.getFullYear()}`;
      const name = `Data_HP_${tA.replace(/\//g,'')}_${tB.replace(/\//g,'')}_${sF}_${ds}.xlsx`;
      const rows = filteredData.map(it=>({
        'ID': it.id || it.row || '', 'Tanggal': it.tanggal || '', 'NPK': it.npk || '', 'Nama': it.nama || '', 'No. Telp': it.notelp || '',
        'Instalasi': it.instalasi || '', 'Cicilan': it.cicilan || '', 'Tipe HP': it.tipehp || '', 'Alamat Kirim': it.alamat || '',
        'Keterangan': it.keterangan || '', 'Status': it.status || '', 'Masa Cicilan': it.masaCicilan || '',
        'Stop Mulai': it.stopMulai || '', 'Lanjut Mulai': it.lanjutMulai || ''
      }));
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, 'Data HP');
      const ab = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      await downloadBlob(new Blob([ab], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }), name);
      showNotification('success','Berhasil','Excel dibuat.');
    }

    async function exportToPDF(){
      if (!filteredData.length) { showNotification('warning','Peringatan','Tidak ada data untuk diekspor'); return; }
      showNotification('info','Ekspor','Menyiapkan PDF...');
      const tA = $('#filter-tanggal-awal').val() || 'Awal';
      const tB = $('#filter-tanggal-akhir').val() || 'Akhir';
      const sF = $('#filter-status').val() || 'Semua';
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      doc.setFontSize(18); doc.text('Data HP Karyawan', 105, 15, { align:'center' });
      doc.setFontSize(10);
      const d = new Date(); const ds = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
      doc.text(`Tanggal: ${ds}`, 105, 25, { align:'center' });
      doc.text(`Periode: ${tA} - ${tB}`, 105, 30, { align:'center' });
      doc.text(`Status: ${sF}`, 105, 35, { align:'center' });
      const body = filteredData.map(it=>[
        it.id||it.row||'', it.tanggal||'', it.npk||'', it.nama||'', it.notelp||'',
        it.cicilan||'', it.tipehp||'', it.status||'', it.masaCicilan||'-'
      ]);
      doc.autoTable({
        head:[['ID','Tanggal','NPK','Nama','No. Telp','Cicilan','Tipe HP','Status','Masa Cicilan']],
        body, startY:40, styles:{ fontSize:8, cellPadding:3 }, headStyles:{ fillColor:[245,158,11], textColor:255 }
      });
      const safe = `Data_HP_${tA.replace(/\//g,'')}_${tB.replace(/\//g,'')}_${sF}_${ds.replaceAll('/','')}.pdf`;
      await downloadBlob(doc.output('blob'), safe);
      showNotification('success','Berhasil','PDF dibuat.');
    }

    // =================================== FUNGSI TAB VENDOR ===================================
    function syncVendorFromAll(){
      vendorData = (allData||[]).map(x=>({
        tanggal:x.tanggal||'', npk:x.npk||'', nama:x.nama||'', notelp:x.notelp||'',
        tipehp:x.tipehp||'', status:x.status||'', alamat:x.alamat||''
      }));
      vendorFiltered = [...vendorData];
    }

    function filterVendor(){
      const q = ($('#vendor-search-input').val() || '').toLowerCase();
      const tAwal = $('#vendor-tanggal-awal').val();
      const tAkhir = $('#vendor-tanggal-akhir').val();
      const tipe = $('#vendor-filter-tipehp').val();
      const stat = ($('#vendor-filter-status').val() || '').toUpperCase();
      const dir = $('#vendor-sort-tanggal').val() || 'desc';
      vendorFiltered = vendorData.filter(r=>{
        let ok = true;
        if (tAwal){ const a = parseDate(tAwal), t = parseDate(r.tanggal); ok = ok && (!a || (t && t >= a)); }
        if (tAkhir){ const b = parseDate(tAkhir); if (b) b.setHours(23,59,59,999); const t = parseDate(r.tanggal); ok = ok && (!b || (t && t <= b)); }
        if (tipe) {
          const tp = (r.tipehp||'').toUpperCase();
          ok = ok && (tipe==='LAINNYA' ? tp==='LAINNYA' : tp.includes(tipe));
        }
        if (stat) ok = ok && ((r.status||'').toUpperCase() === stat);
        if (q) ok = ok && ( (r.npk||'').toLowerCase().includes(q) || (r.nama||'').toLowerCase().includes(q) ||
                            (r.notelp||'').toLowerCase().includes(q) || (r.tipehp||'').toLowerCase().includes(q) ||
                            (r.alamat||'').toLowerCase().includes(q) || (r.tanggal||'').toLowerCase().includes(q) ||
                            (r.status||'').toLowerCase().includes(q) );
        return ok;
      });
      vendorFiltered.sort((a,b)=>{
        const A = parseDate(a.tanggal) || new Date(0);
        const B = parseDate(b.tanggal) || new Date(0);
        if (A < B) return dir==='asc' ? -1 : 1;
        if (A > B) return dir==='asc' ? 1 : -1;
        return 0;
      });
      renderVendorTable();
    }

    function renderVendorTable(){
      const $tb = $('#vendor-table tbody').empty();
      if (!vendorFiltered.length){
        $tb.append('<tr><td colspan="7" class="px-4 py-4 text-center text-gray-500">Tidak ada data</td></tr>');
      } else {
        vendorFiltered.forEach(r=>{
          const digits = normalizeTo62(r.notelp);
          const waLink = digits ? `<a href="https://wa.me/${digits}" target="_blank" rel="noopener noreferrer" class="whatsapp-link hover:underline">${r.notelp||''}</a>` : (r.notelp||'');
          let statusBadge = '';
          if (r.status==='OK') statusBadge = '<span class="badge badge-go"><i class="fas fa-check-circle"></i> OK</span>';
          else if (['CANCEL','NO ACC'].includes(r.status)) statusBadge = `<span class="badge badge-stop"><i class="fas fa-times-circle"></i> ${r.status}</span>`;
          else if (r.status==='VERIFIKASI') statusBadge = '<span class="badge" style="background:#fef3c7;color:#92400e"><i class="fas fa-exclamation-circle"></i> VERIFIKASI</span>';
          else statusBadge = '<span class="badge" style="background:#f3f4f6;color:#4b5563"><i class="fas fa-question-circle"></i> -</span>';
          $tb.append(`<tr>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${r.tanggal}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${r.npk}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${r.nama}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${waLink}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${r.tipehp}</td>
            <td class="px-2 md:px-4 py-3 text-sm">${statusBadge}</td>
            <td class="px-2 md:px-4 py-3 text-sm text-gray-900">${r.alamat || '-'}</td>
          </tr>`);
        });
      }
      $('#vendor-showing-count').text(vendorFiltered.length);
      $('#vendor-total-count').text(vendorData.length);
    }
    
    async function exportVendorToExcel(){
      if (!vendorFiltered.length){ showNotification('warning','Peringatan','Tidak ada data untuk diekspor'); return; }
      showNotification('info','Ekspor','Menyiapkan Excel (vendor)...');
      const tA = $('#vendor-tanggal-awal').val() || 'Awal';
      const tB = $('#vendor-tanggal-akhir').val() || 'Akhir';
      const tipe = $('#vendor-filter-tipehp').val() || 'Semua';
      const stat = $('#vendor-filter-status').val() || 'Semua';
      const d = new Date(); const ds = `${String(d.getDate()).padStart(2,'0')}${String(d.getMonth()+1).padStart(2,'0')}${d.getFullYear()}`;
      const name = `Vendor_HP_${tA.replace(/\//g,'')}_${tB.replace(/\//g,'')}_${tipe}_${stat}_${ds}.xlsx`;
      const rows = vendorFiltered.map(r=>({
        'Tanggal': r.tanggal, 'NPK': r.npk, 'Nama': r.nama, 'No. Telp': r.notelp, 'Tipe': r.tipehp, 'Status': r.status, 'Alamat Kirim': r.alamat
      }));
      const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, 'Vendor');
      const ab = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      await downloadBlob(new Blob([ab], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }), name);
      showNotification('success','Berhasil','Excel vendor dibuat.');
    }

    async function exportVendorToPDF(){
      if (!vendorFiltered.length){ showNotification('warning','Peringatan','Tidak ada data untuk diekspor'); return; }
      showNotification('info','Ekspor','Menyiapkan PDF (vendor)...');
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      doc.setFontSize(16); doc.text('Data HP - Vendor (Semua Data)', 105, 15, { align:'center' });
      doc.setFontSize(10);
      const d = new Date(); const ds = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
      const tA = $('#vendor-tanggal-awal').val() || 'Awal';
      const tB = $('#vendor-tanggal-akhir').val() || 'Akhir';
      const tipe = $('#vendor-filter-tipehp').val() || 'Semua';
      const stat = $('#vendor-filter-status').val() || 'Semua';
      doc.text(`Tanggal cetak: ${ds}`, 105, 22, { align:'center' });
      doc.text(`Periode: ${tA} - ${tB}`, 105, 27, { align:'center' });
      doc.text(`Tipe HP: ${tipe} | Status: ${stat}`, 105, 32, { align:'center' });
      const body = vendorFiltered.map(r => [r.tanggal, r.npk, r.nama, r.notelp, r.tipehp, r.status, r.alamat]);
      doc.autoTable({ head: [['Tanggal','NPK','Nama','No. Telp','Tipe','Status','Alamat Kirim']], body, startY: 37, styles: { fontSize: 8, cellPadding: 3 }, headStyles: { fillColor: [245,158,11], textColor: 255 } });
      const safe = `Vendor_HP_${tA.replace(/\//g,'')}_${tB.replace(/\//g,'')}_${tipe}_${stat}_${ds.replaceAll('/','')}.pdf`;
      await downloadBlob(doc.output('blob'), safe);
      showNotification('success','Berhasil','PDF vendor dibuat.');
    }

    async function exportVendorToJPEG(){
      if (!vendorFiltered.length){ showNotification('warning','Peringatan','Tidak ada data untuk diekspor'); return; }
      showNotification('info','Ekspor','Menyiapkan JPEG (vendor)...');
      const cont = document.createElement('div');
      cont.className = 'vendor-capture-container';
      cont.style.width = '1000px';
      const title = document.createElement('div'); title.className='vendor-capture-title'; title.textContent='Data HP - Vendor (Semua Data)';
      const info = document.createElement('div'); info.className='vendor-capture-date';
      const d = new Date(); const ds = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
      const tA = $('#vendor-tanggal-awal').val() || 'Awal';
      const tB = $('#vendor-tanggal-akhir').val() || 'Akhir';
      const tipe = $('#vendor-filter-tipehp').val() || 'Semua';
      const stat = $('#vendor-filter-status').val() || 'Semua';
      info.textContent = `Tanggal: ${ds} | Periode: ${tA} - ${tB} | Tipe HP: ${tipe} | Status: ${stat}`;
      const table = document.getElementById('vendor-table').cloneNode(true);
      table.style.width = '100%'; table.style.borderCollapse = 'collapse'; table.style.fontSize = '12px';
      const style = document.createElement('style');
      style.textContent = `table th, table td { border:1px solid #ddd; padding:8px; text-align:left; }
                           table th { background:#f2f2f2; font-weight:bold; } table tr:nth-child(even){ background:#f9f9f9; }`;
      cont.appendChild(title); cont.appendChild(info); cont.appendChild(style); cont.appendChild(table);
      document.body.appendChild(cont);
      try{
        const canvas = await html2canvas(cont, { scale: 2, logging:false, useCORS:true });
        canvas.toBlob(async blob => {
          document.body.removeChild(cont);
          const safe = `Vendor_HP_${tA.replace(/\//g,'')}_${tB.replace(/\//g,'')}_${tipe}_${stat}_${ds.replaceAll('/','')}.jpg`;
          await downloadBlob(blob, safe);
          showNotification('success','Berhasil','JPEG vendor dibuat.');
        }, 'image/jpeg', 0.9);
      } catch(e) {
        document.body.removeChild(cont);
        console.error(e);
        showNotification('error','Gagal','Kesalahan saat membuat JPEG');
      }
    }

    // =================================== FUNGSI TAB DASHBOARD ===================================
    function updateDashboardCounters(){
      $('#total-hp').text(allData.length);
      $('#status-ok').text(allData.filter(x => x.status==='OK').length);
      $('#status-proses').text(allData.filter(x => x.status==='VERIFIKASI').length);
      $('#status-issues').text(allData.filter(x => ['CANCEL','NO ACC'].includes(x.status||'')).length);
    }

    function loadDashboard(){
      updateDashboardCounters();
      const tipeHpCounts = {};
      const statusCounts = { 'OK':0, 'CANCEL':0, 'NO ACC':0, 'VERIFIKASI':0, 'Lainnya':0 };
      allData.forEach(it=>{
        if (it.tipehp) tipeHpCounts[it.tipehp] = (tipeHpCounts[it.tipehp]||0)+1;
        if (['OK','CANCEL','NO ACC','VERIFIKASI'].includes(it.status)) statusCounts[it.status] = (statusCounts[it.status]||0)+1;
        else statusCounts['Lainnya'] = (statusCounts['Lainnya']||0)+1;
      });
      const ctx1 = document.getElementById('tipe-hp-chart').getContext('2d');
      if (tipeHpChart) tipeHpChart.destroy();
      tipeHpChart = new Chart(ctx1, {
        type:'bar',
        data:{ labels:Object.keys(tipeHpCounts), datasets:[{ label:'Jumlah HP', data:Object.values(tipeHpCounts), backgroundColor:'rgba(245, 158, 11, 0.7)', borderColor:'rgba(245,158,11,1)', borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
      const ctx2 = document.getElementById('status-chart').getContext('2d');
      if (statusChart) statusChart.destroy();
      const baseColors = ['#22c55e','#ef4444','#ef4444','#f59e0b','#9ca3af'];
      statusChart = new Chart(ctx2, {
        type:'doughnut',
        data:{ labels:Object.keys(statusCounts), datasets:[{ data:Object.values(counts), backgroundColor:baseColors, borderColor:baseColors, borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right' } } }
      });
    }

    // =================================== FUNGSI TAB PEMBANDING VENDOR ===================================
    function formatHarga(h){ return h!=null ? `Rp ${Number(h).toLocaleString('id-ID')}` : '-'; }

    function guessBrand(name){
      const u = normName(name);
      const map = [
        ['VIVO','VIVO'], ['REDMI','XIAOMI'], ['POCO','XIAOMI'], ['XIAOMI','XIAOMI'],
        ['OPPO','OPPO'], ['REALME','REALME'], ['SAMSUNG','SAMSUNG'],
        ['INFINIX','INFINIX'], ['TECNO','TECNO'], ['ADVAN','ADVAN']
      ];
      for (const [k,v] of map){ if (u.startsWith(k+' ')) return v; }
      return (u.split(' ')[0]||'LAINNYA');
    }

    function getCompareRows(){
      const tA = $('#compare-tanggal-awal').val();
      const tB = $('#compare-tanggal-akhir').val();
      const start = tA ? parseDate(tA) : null;
      const end   = tB ? parseDate(tB) : null;
      if (end) end.setHours(23,59,59,999);
      const rows = (allData||[])
        .filter(d => (d.tipehp||'').trim())
        .filter(d => {
          if (!start && !end) return true;
          const t = parseDate(d.tanggal);
          if (!t) return false;
          let ok = true;
          if (start) ok = ok && (t >= start);
          if (end)   ok = ok && (t <= end);
          return ok;
        });
      rows.sort((a,b)=>{
        const da = parseDate(a.tanggal) || new Date(0);
        const db = parseDate(b.tanggal) || new Date(0);
        if (db - da !== 0) return db - da;
        return (a.nama||'').localeCompare(b.nama||'');
      });
      return rows;
    }

    function renderCompareTable(){
      const $tb = $('#compare-table tbody').empty();
      const rows = getCompareRows();
      rows.forEach(d=>{
        const tipe  = d.tipehp || '';
        const merek = guessBrand(tipe);
        const hA = getHargaFast('alfacell', tipe);
        const hS = getHargaFast('sentral', tipe);

        const vendor = (function(){
          if (hA!=null && hS!=null) return (hA<=hS) ? VENDOR_LABEL_ALF : VENDOR_LABEL_SA;
          if (hA!=null) return VENDOR_LABEL_ALF;
          if (hS!=null) return VENDOR_LABEL_SA;
          return '-';
        })();
        const tips = `${VENDOR_LABEL_ALF}: ${formatHarga(hA)} | ${VENDOR_LABEL_SA}: ${formatHarga(hS)}`;
        const hint = (vendor === '-') ? ' (tipe belum ada di DB harga)' : '';
        $tb.append(`
          <tr>
            <td class="px-2 py-2 text-sm">${d.tanggal||''}</td>
            <td class="px-2 py-2 text-sm">${d.npk||''}</td>
            <td class="px-2 py-2 text-sm">${d.nama||''}</td>
            <td class="px-2 py-2 text-sm">${tipe}</td>
            <td class="px-2 py-2 text-sm">${merek}</td>
            <td class="px-2 py-2 text-sm" title="${tips}">${vendor}${hint}</td>
          </tr>
        `);
      });
      if (!rows.length){
        $tb.append('<tr><td colspan="6" class="px-2 py-3 text-center text-gray-500">Tidak ada data pada periode ini.</td></tr>');
      }
      $('#compare-count').text(rows.length);
    }

    async function exportCompareToExcel(){
      const rows = getCompareRows();
      if (!rows.length){ showNotification('warning','Peringatan','Tidak ada data pembanding untuk diekspor'); return; }
      showNotification('info','Ekspor','Menyiapkan Excel (pembanding)...');
      const data = rows.map(d=>{
        const tipe  = d.tipehp || '';
        const merek = guessBrand(tipe);
        const hA = getHargaFast('alfacell', tipe);
        const hS = getHargaFast('sentral', tipe);
        let vendorTermurah = '-';
        if (hA!=null && hS!=null) vendorTermurah = (hA<=hS)?'Alfacell':'Sentral Abadi Jaya';
        else if (hA!=null) vendorTermurah = VENDOR_LABEL_ALF;
        else if (hS!=null) vendorTermurah = VENDOR_LABEL_SA;
        return {
          'Tanggal': d.tanggal||'', 'NPK': d.npk||'', 'Nama': d.nama||'',
          'Tipe HP': tipe, 'Merek': merek, 'Vendor Termurah': vendorTermurah
        };
      });
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, 'Pembanding');
      const tA = ($('#compare-tanggal-awal').val()||'Awal').replace(/\//g,'');
      const tB = ($('#compare-tanggal-akhir').val()||'Akhir').replace(/\//g,'');
      const d  = new Date(); const ds = `${String(d.getDate()).padStart(2,'0')}${String(d.getMonth()+1).padStart(2,'0')}${d.getFullYear()}`;
      const name = `Pembanding_Vendor_${tA}_${tB}_${ds}.xlsx`;
      const ab = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      await downloadBlob(new Blob([ab], { type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }), name);
      showNotification('success','Berhasil','Excel pembanding dibuat.');
    }

    async function exportCompareToPDF(){
      const rows = getCompareRows();
      if (!rows.length){ showNotification('warning','Peringatan','Tidak ada data pembanding untuk diekspor'); return; }
      showNotification('info','Ekspor','Menyiapkan PDF (pembanding)...');
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16); doc.text('Pembanding Harga Vendor', 105, 15, { align:'center' });
      doc.setFontSize(10);
      const now = new Date();
      const ds = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()}`;
      const tA = $('#compare-tanggal-awal').val() || 'Awal';
      const tB = $('#compare-tanggal-akhir').val() || 'Akhir';
      doc.text(`Tanggal cetak: ${ds}`, 105, 22, { align:'center' });
      doc.text(`Periode: ${tA} - ${tB}`, 105, 27, { align:'center' });
      const body = rows.map(d=>{
        const tipe  = d.tipehp || ''; const merek = guessBrand(tipe);
        const hA = getHargaFast('alfacell', tipe); const hS = getHargaFast('sentral', tipe);
        let vendor = '-';
        if (hA!=null && hS!=null) vendor = (hA<=hS) ? VENDOR_LABEL_ALF : VENDOR_LABEL_SA;
        else if (hA!=null) vendor = VENDOR_LABEL_ALF;
        else if (hS!=null) vendor = VENDOR_LABEL_SA;
        return [d.tanggal||'', d.npk||'', d.nama||'', tipe, merek, vendor];
      });
      doc.autoTable({
        head: [['Tanggal','NPK','Nama','Tipe HP','Merek','Vendor']], body, startY: 34,
        styles: { fontSize: 8, cellPadding: 3 }, headStyles: { fillColor: [245,158,11], textColor: 255 }
      });
      const safe = `Pembanding_Vendor_${tA.replace(/\//g,'')}_${tB.replace(/\//g,'')}_${ds.replaceAll('/','')}.pdf`;
      await downloadBlob(doc.output('blob'), safe);
      showNotification('success','Berhasil','PDF pembanding dibuat.');
    }

    async function exportCompareToJPEG(){
      const rows = getCompareRows();
      if (!rows.length){ showNotification('warning','Peringatan','Tidak ada data pembanding untuk diekspor'); return; }
      showNotification('info','Ekspor','Menyiapkan JPEG (pembanding)...');
      const cont = document.createElement('div');
      cont.className = 'vendor-capture-container';
      cont.style.width = '1000px';
      const title = document.createElement('div'); title.className='vendor-capture-title'; title.textContent='Pembanding Harga Vendor';
      const info = document.createElement('div'); info.className='vendor-capture-date';
      const now = new Date();
      const ds = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()}`;
      const tA = $('#compare-tanggal-awal').val() || 'Awal';
      const tB = $('#compare-tanggal-akhir').val() || 'Akhir';
      info.textContent = `Tanggal: ${ds} | Periode: ${tA} - ${tB}`;
      const table = document.getElementById('compare-table').cloneNode(true);
      table.style.width = '100%'; table.style.borderCollapse = 'collapse'; table.style.fontSize = '12px';
      const style = document.createElement('style');
      style.textContent = `table th, table td { border:1px solid #ddd; padding:8px; text-align:left; }
                           table th { background:#f2f2f2; font-weight:bold; } table tr:nth-child(even){ background:#f9f9f9; }`;
      cont.appendChild(title); cont.appendChild(info); cont.appendChild(style); cont.appendChild(table);
      document.body.appendChild(cont);
      try{
        const canvas = await html2canvas(cont, { scale: 2, logging:false, useCORS:true });
        canvas.toBlob(async blob => {
          document.body.removeChild(cont);
          const safe = `Pembanding_Vendor_${tA.replace(/\//g,'')}_${tB.replace(/\//g,'')}_${ds.replaceAll('/','')}.jpg`;
          await downloadBlob(blob, safe);
          showNotification('success','Berhasil','JPEG pembanding dibuat.');
        }, 'image/jpeg', 0.9);
      } catch(e) {
        document.body.removeChild(cont);
        console.error(e);
        showNotification('error','Gagal','Kesalahan saat membuat JPEG');
      }
    }

    // =================================== FUNGSI TAB DASHBOARD ===================================
    function updateDashboardCounters(){
      $('#total-hp').text(allData.length);
      $('#status-ok').text(allData.filter(x => x.status==='OK').length);
      $('#status-proses').text(allData.filter(x => x.status==='VERIFIKASI').length);
      $('#status-issues').text(allData.filter(x => ['CANCEL','NO ACC'].includes(x.status||'')).length);
    }

    function loadDashboard(){
      updateDashboardCounters();
      const tipeHpCounts = {};
      const statusCounts = { 'OK':0, 'CANCEL':0, 'NO ACC':0, 'VERIFIKASI':0, 'Lainnya':0 };
      allData.forEach(it=>{
        if (it.tipehp) tipeHpCounts[it.tipehp] = (tipeHpCounts[it.tipehp]||0)+1;
        if (['OK','CANCEL','NO ACC','VERIFIKASI'].includes(it.status)) statusCounts[it.status] = (statusCounts[it.status]||0)+1;
        else statusCounts['Lainnya'] = (counts['Lainnya']||0)+1;
      });
      const ctx1 = document.getElementById('tipe-hp-chart').getContext('2d');
      if (tipeHpChart) tipeHpChart.destroy();
      tipeHpChart = new Chart(ctx1, {
        type:'bar',
        data:{ labels:Object.keys(tipeHpCounts), datasets:[{ label:'Jumlah HP', data:Object.values(tipeHpCounts), backgroundColor:'rgba(245, 158, 11, 0.7)', borderColor:'rgba(245,158,11,1)', borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
      const ctx2 = document.getElementById('status-chart').getContext('2d');
      if (statusChart) statusChart.destroy();
      const baseColors = ['#22c55e','#ef4444','#ef4444','#f59e0b','#9ca3af'];
      statusChart = new Chart(ctx2, {
        type:'doughnut',
        data:{ labels:Object.keys(statusCounts), datasets:[{ data:Object.values(counts), backgroundColor:baseColors, borderColor:baseColors, borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'right' } } }
      });
    }

    // =================================== INTI APLIKASI ===================================
    $(function(){
      // Inisialisasi Datepicker
      $(".tanggal-input").datepicker({ dateFormat: "dd/mm/yy", changeMonth: true, changeYear: true, yearRange: "2020:2035" });

      // Event listener untuk navigasi tab
      $('.tab-btn').on('click', async function() {
        const tabId = $(this).data('tab');
        $('.tab-btn').removeClass('border-b-2 border-yellow-500 text-yellow-600').addClass('text-gray-500 hover:text-gray-700');
        $(this).removeClass('text-gray-500 hover:text-gray-700').addClass('border-b-2 border-yellow-500 text-yellow-600');
        $('.tab-content').addClass('section-hidden');
        $(`#${tabId}-section`).removeClass('section-hidden');

        // Panggil fungsi render yang sesuai dengan tab yang diaktifkan
        if (tabId === 'data') renderTable();
        if (tabId === 'dashboard') loadDashboard();
        if (tabId === 'vendor') { syncVendorFromAll(); renderVendorTable(); }
        if (tabId === 'compare') {
          if (!priceReady) await loadPriceDB();
          renderCompareTable();
        }
      });

      // Event listener form input data
      $('#input-form').on('submit', e => { e.preventDefault(); submitForm(); });
      $('#edit-form').on('submit', e => { e.preventDefault(); updateData(); });
      $('#close-modal-btn').on('click', () => $('#edit-modal').addClass('hidden'));

      // Event listener tab Data
      $('#refresh-btn').on('click', loadData);
      $('#export-excel-btn').on('click', exportToExcel);
      $('#export-pdf-btn').on('click', exportToPDF);
      $('#search-input').on('input', filterData);
      $('#filter-status').on('change', filterData);
      $('#filter-tanggal-awal, #filter-tanggal-akhir').on('change', filterData);
      $('#sort-tanggal').on('change', function(){ sortColumn='tanggal'; sortDirection=$(this).val(); updateSortIndicators(); sortData(); renderTable(); });
      $('#data-table thead').on('click', 'th.sortable', thSortHandler);

      // Cek angsuran saat NPK diinput
      $('#npk').on('input blur', function(){ checkAngsuranOnInput($(this).val().trim()); });
      $('#angsuran-ack-input').on('change', function(){
        const needAck = !$('#angsuran-warning-input').hasClass('hidden');
        toggleSubmitDisabled(!( $(this).is(':checked') || !needAck ));
      });

      // Event listener tab Vendor
      $('#vendor-refresh-btn').on('click', () => { syncVendorFromAll(); renderVendorTable(); });
      $('#vendor-export-excel-btn').on('click', exportVendorToExcel);
      $('#vendor-export-pdf-btn').on('click', exportVendorToPDF);
      $('#vendor-export-jpeg-btn').on('click', exportVendorToJPEG);
      $('#vendor-search-input').on('input', filterVendor);
      $('#vendor-sort-tanggal').on('change', filterVendor);
      $('#vendor-filter-tipehp').on('change', filterVendor);
      $('#vendor-filter-status').on('change', filterVendor);
      $('#vendor-tanggal-awal, #vendor-tanggal-akhir').on('change', filterVendor);
      $('#vendor-clear-filter').on('click', () => {
        $('#vendor-search-input').val('');
        $('#vendor-sort-tanggal').val('desc');
        $('#vendor-filter-tipehp').val('');
        $('#vendor-filter-status').val('');
        $('#vendor-tanggal-awal').val('');
        $('#vendor-tanggal-akhir').val('');
        vendorFiltered = [...vendorData];
        renderVendorTable();
      });

      // Event listener tab Pembanding Vendor
      $('#compare-tanggal-awal, #compare-tanggal-akhir').on('change', renderCompareTable);
      $('#compare-clear-filter').on('click', () => {
        $('#compare-tanggal-awal').val('');
        $('#compare-tanggal-akhir').val('');
        renderCompareTable();
      });
      $('#compare-export-excel-btn').on('click', exportCompareToExcel);
      $('#compare-export-pdf-btn').on('click', exportCompareToPDF);
      $('#compare-export-jpeg-btn').on('click', exportCompareToJPEG);

      // Muat DB harga dulu, lalu data utama
      loadPriceDB()
        .then(() => {
          loadData();
          if (!$('#compare-section').hasClass('section-hidden')) {
            renderCompareTable();
          }
        })
        .catch(() => {
          loadData();
        });
    });
  
  // === PATCH: CUSTOM TIPE HP MERGE ===
  const TIPE_HP_CUSTOM = ['VIVO Y29 6/128', 'VIVO Y29 8/128', 'VIVO Y29 8/256', 'Y19S PRO 4/64 GB', 'Y19S PRO 4/128 GB', 'Y19S PRO 6/128 GB', 'REDMI 14C 6/128', 'REDMI 14C 8/256', 'REDMI NOTE 14 8/128', 'REDMI NOTE 14 8/256', 'REDMI NOTE 14 8/256 5G', 'REDMI NOTE 14 12/512 5G', 'REDMI 13 8/128', 'REDMI 13 8/256', 'REDMI POCO PAD 8/256', 'OPPO A60 8/256', 'OPPO A3X 6/128', 'REALME C75 8/128', 'REALME C75 8/256', 'REALME NOTE 60 6/128', 'SAMSUNG A06 4/64', 'SAMSUNG A06 4/128', 'SAMSUNG A06 6/128', 'SAMSUNG A16 8/128', 'SAMSUNG A16 8/256', 'SAMSUNG A16 8/256 5G', 'SMART 10 4/128 GB', 'SMART 10 PLUS 8/128 GB', 'HOT 60i 8/256 GB', 'HOT 60 PRO 8/256 GB', 'INFINIX HOT 50 PRO+ 8/256', 'TECNO SPARK GO 1 4/128', 'POVA 7 8/128 GB', 'POVA 7 8/256 GB', 'CAMON 40 8/256 GB', 'ADVAN TAB VX LITE 6/128GB'];

  // Re-define to merge DB rows with the custom list provided by admin
  function populateTipeOptionsFromPriceDB(rows = []){
    const set = new Set();
    // from DB (PRICE_ENDPOINT)
    rows.forEach(r => {
      const t = String(r['TIPE BARANG'] || r['tipe'] || r['Tipe'] || r['TIPE'] || '').trim();
      if (t) set.add(t);
    });
    // from custom list (deduped)
    (TIPE_HP_CUSTOM || []).forEach(t => { if (t && typeof t === 'string') set.add(t.trim()); });
    // build sorted
    const tipes = Array.from(set).sort((a,b)=>a.localeCompare(b));
    const fill = ($sel) => {
      $sel.empty().append('<option value="">Pilih Tipe HP</option>');
      tipes.forEach(t => $sel.append(`<option>${t}</option>`));
      $sel.append('<option>LAINNYA</option>');
    };
    fill($('#tipehp'));
    fill($('#edit-tipehp'));
  }
  // === END PATCH ===

  // === PATCH: NORMALIZE WA 62 ===
  function normalizeTo62(raw){
    let digits = String(raw||'').replace(/\D/g,'');
    if(!digits) return '';
    if(digits.startsWith('62')) {
      // collapse any extra leading zeros after country code
      digits = '62' + digits.slice(2).replace(/^0+/, '');
      return digits;
    }
    if(digits.startsWith('0')) return '62' + digits.slice(1);
    if(digits.startsWith('8')) return '62' + digits;
    // fallback: just ensure 62 prefix
    return '62' + digits;
  }
  // === END PATCH ===
</script>
</body>
</html>
